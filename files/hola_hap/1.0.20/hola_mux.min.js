!function(a){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=a();else if("function"==typeof define&&define.amd)define([],a);else{var b;b="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,b.muxjs=a()}}(function(){return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c||a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){"use strict";var d,e=a("../utils/stream.js");d=function(){var a=new Uint8Array,b=0;d.prototype.init.call(this),this.setTimestamp=function(a){b=a},this.parseId3TagSize=function(a,b){var c=a[b+6]<<21|a[b+7]<<14|a[b+8]<<7|a[b+9];return(16&a[b+5])>>4?c+20:c+10},this.parseAdtsSize=function(a,b){var c=(224&a[b+5])>>5,d=a[b+4]<<3;return 6144&a[b+3]|d|c},this.push=function(c){var d,e,f,g,h=0,i=0;for(a.length?(g=a.length,a=new Uint8Array(c.byteLength+g),a.set(a.subarray(0,g)),a.set(c,g)):a=c;a.length-i>=3;)if(a[i]!=="I".charCodeAt(0)||a[i+1]!=="D".charCodeAt(0)||a[i+2]!=="3".charCodeAt(0))if(a[i]&!0&&240==(240&a[i+1])){if(a.length-i<7)break;if((h=this.parseAdtsSize(a,i))>a.length)break;f={type:"audio",data:a.subarray(i,i+h),pts:b,dts:b},this.trigger("data",f),i+=h}else i++;else{if(a.length-i<10)break;if((h=this.parseId3TagSize(a,i))>a.length)break;e={type:"timed-metadata",data:a.subarray(i,i+h)},this.trigger("data",e),i+=h}d=a.length-i,a=d>0?a.subarray(i):new Uint8Array}},d.prototype=new e,b.exports=d},{"../utils/stream.js":22}],2:[function(a,b,c){"use strict";var d,e=a("../utils/stream.js"),f=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];d=function(){var a;d.prototype.init.call(this),this.push=function(b){var c,d,e,g,h,i,j=0,k=0;if("audio"===b.type)for(a?(g=a,a=new Uint8Array(g.byteLength+b.data.byteLength),a.set(g),a.set(b.data,g.byteLength)):a=b.data;j+5<a.length;)if(255===a[j]&&240==(246&a[j+1])){if(d=2*(1&~a[j+1]),c=(3&a[j+3])<<11|a[j+4]<<3|(224&a[j+5])>>5,h=1024*(1+(3&a[j+6])),i=9e4*h/f[(60&a[j+2])>>>2],e=j+c,a.byteLength<e)return;if(this.trigger("data",{pts:b.pts+k*i,dts:b.dts+k*i,sampleCount:h,audioobjecttype:1+(a[j+2]>>>6&3),channelcount:(1&a[j+2])<<2|(192&a[j+3])>>>6,samplerate:f[(60&a[j+2])>>>2],samplingfrequencyindex:(60&a[j+2])>>>2,samplesize:16,data:a.subarray(j+7+d,e)}),a.byteLength===e)return void(a=void 0);k++,a=a.subarray(e)}else j++},this.flush=function(){this.trigger("done")}},d.prototype=new e,b.exports=d},{"../utils/stream.js":22}],3:[function(a,b,c){"use strict";var d,e,f=a("../utils/stream.js"),g=a("../utils/exp-golomb.js"),h={100:!0,110:!0,122:!0,244:!0,44:!0,83:!0,86:!0,118:!0,128:!0,138:!0,139:!0,134:!0},i={slice_layer_without_partitioning_rbsp:1,slice_layer_without_partitioning_rbsp_idr:5,sei_rbsp:6,seq_parameter_set_rbsp:7,pic_parameter_set_rbsp:8,access_unit_delimiter_rbsp:9};e=function(){var a,b,c=0;e.prototype.init.call(this),this.push=function(d){var e;for(b?(e=new Uint8Array(b.byteLength+d.data.byteLength),e.set(b),e.set(d.data,b.byteLength),b=e):b=d.data;c<b.byteLength-3;c++)if(1===b[c+2]){a=c+5;break}for(;a<b.byteLength;)switch(b[a]){case 0:if(0!==b[a-1]){a+=2;break}if(0!==b[a-2]){a++;break}c+3!==a-2&&this.trigger("data",b.subarray(c+3,a-2));do{a++}while(1!==b[a]&&a<b.length);c=a-2,a+=3;break;case 1:if(0!==b[a-1]||0!==b[a-2]){a+=3;break}this.trigger("data",b.subarray(c+3,a-2)),c=a-2,a+=3;break;default:a+=3}b=b.subarray(c),a-=c,c=0},this.flush=function(){b&&b.byteLength>3&&this.trigger("data",b.subarray(c+3)),b=null,c=0,this.trigger("done")}},e.prototype=new f,d=function(){var a,b,c,f,i,j,k,l=new e;d.prototype.init.call(this),a=this,this.push=function(a){"video"===a.type&&(b=a.trackId,c=a.pts,f=a.dts,l.push(a))},l.on("data",function(d){var e={trackId:b,pts:c,dts:f,data:d},g=31&d[0];(1==g||g>=5&&g<=9)&&(e.nalUnitType=g),7!=g&&6!=g||(e.escapedRBSP=i(d.subarray(1)),e.config=7==g?j(e.escapedRBSP):null),a.trigger("data",e)}),l.on("done",function(){a.trigger("done")}),this.flush=function(){l.flush()},k=function(a,b){var c,d,e=8,f=8;for(c=0;c<a;c++)0!==f&&(d=b.readExpGolomb(),f=(e+d+256)%256),e=0===f?e:f},i=function(a){for(var b,c,d=a.byteLength,e=[],f=1;f<d-2;)0===a[f]&&0===a[f+1]&&3===a[f+2]?(e.push(f+2),f+=2):f++;if(0===e.length)return a;b=d-e.length,c=new Uint8Array(b);var g=0;for(f=0;f<b;g++,f++)g===e[0]&&(g++,e.shift()),c[f]=a[g];return c},j=function(a){var b,c,d,e,f,i,j,l,m,n,o,p,q,r=0,s=0,t=0,u=0,v=1;if(b=new g(a),c=b.readUnsignedByte(),e=b.readUnsignedByte(),d=b.readUnsignedByte(),b.skipUnsignedExpGolomb(),h[c]&&(f=b.readUnsignedExpGolomb(),3===f&&b.skipBits(1),b.skipUnsignedExpGolomb(),b.skipUnsignedExpGolomb(),b.skipBits(1),b.readBoolean()))for(o=3!==f?8:12,q=0;q<o;q++)b.readBoolean()&&(q<6?k(16,b):k(64,b));if(b.skipUnsignedExpGolomb(),0===(i=b.readUnsignedExpGolomb()))b.readUnsignedExpGolomb();else if(1===i)for(b.skipBits(1),b.skipExpGolomb(),b.skipExpGolomb(),j=b.readUnsignedExpGolomb(),q=0;q<j;q++)b.skipExpGolomb();if(b.skipUnsignedExpGolomb(),b.skipBits(1),l=b.readUnsignedExpGolomb(),m=b.readUnsignedExpGolomb(),n=b.readBits(1),0===n&&b.skipBits(1),b.skipBits(1),b.readBoolean()&&(r=b.readUnsignedExpGolomb(),s=b.readUnsignedExpGolomb(),t=b.readUnsignedExpGolomb(),u=b.readUnsignedExpGolomb()),b.readBoolean()&&b.readBoolean()){switch(b.readUnsignedByte()){case 1:p=[1,1];break;case 2:p=[12,11];break;case 3:p=[10,11];break;case 4:p=[16,11];break;case 5:p=[40,33];break;case 6:p=[24,11];break;case 7:p=[20,11];break;case 8:p=[32,11];break;case 9:p=[80,33];break;case 10:p=[18,11];break;case 11:p=[15,11];break;case 12:p=[64,33];break;case 13:p=[160,99];break;case 14:p=[4,3];break;case 15:p=[3,2];break;case 16:p=[2,1];break;case 255:p=[b.readUnsignedByte()<<8|b.readUnsignedByte(),b.readUnsignedByte()<<8|b.readUnsignedByte()]}p&&(v=p[0]/p[1])}return{profileIdc:c,levelIdc:d,profileCompatibility:e,width:Math.ceil((16*(l+1)-2*r-2*s)*v),height:(2-n)*(m+1)*16-2*t-2*u}}},d.prototype=new f,b.exports={H264Stream:d,NalByteStream:e,unitTypes:i}},{"../utils/exp-golomb.js":21,"../utils/stream.js":22}],4:[function(a,b,c){b.exports={adts:a("./adts"),h264:a("./h264")}},{"./adts":2,"./h264":3}],5:[function(a,b,c){"use strict";var d;d=function(a,b){var c,e=0,f=16384,g=function(a,b){var c,d=a.position+b;d<a.bytes.byteLength||(c=new Uint8Array(2*d),c.set(a.bytes.subarray(0,a.position),0),a.bytes=c,a.view=new DataView(a.bytes.buffer))},h=d.widthBytes||new Uint8Array("width".length),i=d.heightBytes||new Uint8Array("height".length),j=d.videocodecidBytes||new Uint8Array("videocodecid".length);if(!d.widthBytes){for(c=0;c<"width".length;c++)h[c]="width".charCodeAt(c);for(c=0;c<"height".length;c++)i[c]="height".charCodeAt(c);for(c=0;c<"videocodecid".length;c++)j[c]="videocodecid".charCodeAt(c);d.widthBytes=h,d.heightBytes=i,d.videocodecidBytes=j}switch(this.keyFrame=!1,a){case d.VIDEO_TAG:this.length=16,f*=6;break;case d.AUDIO_TAG:this.length=13,this.keyFrame=!0;break;case d.METADATA_TAG:this.length=29,this.keyFrame=!0;break;default:throw"Error Unknown TagType"}this.bytes=new Uint8Array(f),this.view=new DataView(this.bytes.buffer),this.bytes[0]=a,this.position=this.length,this.keyFrame=b,this.pts=0,this.dts=0,this.writeBytes=function(a,b,c){var d,e=b||0;c=c||a.byteLength,d=e+c,g(this,c),this.bytes.set(a.subarray(e,d),this.position),this.position+=c,this.length=Math.max(this.length,this.position)},this.writeByte=function(a){g(this,1),this.bytes[this.position]=a,this.position++,this.length=Math.max(this.length,this.position)},this.writeShort=function(a){g(this,2),this.view.setUint16(this.position,a),this.position+=2,this.length=Math.max(this.length,this.position)},this.negIndex=function(a){return this.bytes[this.length-a]},this.nalUnitSize=function(){return 0===e?0:this.length-(e+4)},this.startNalUnit=function(){if(e>0)throw new Error("Attempted to create new NAL wihout closing the old one");e=this.length,this.length+=4,this.position=this.length},this.endNalUnit=function(a){var b,c;this.length===e+4?this.length-=4:e>0&&(b=e+4,c=this.length-b,this.position=e,this.view.setUint32(this.position,c),this.position=this.length,a&&a.push(this.bytes.subarray(b,b+c))),e=0},this.writeMetaDataDouble=function(a,b){var c;if(g(this,2+a.length+9),this.view.setUint16(this.position,a.length),this.position+=2,"width"===a)this.bytes.set(h,this.position),this.position+=5;else if("height"===a)this.bytes.set(i,this.position),this.position+=6;else if("videocodecid"===a)this.bytes.set(j,this.position),this.position+=12;else for(c=0;c<a.length;c++)this.bytes[this.position]=a.charCodeAt(c),this.position++;this.position++,this.view.setFloat64(this.position,b),this.position+=8,this.length=Math.max(this.length,this.position),++e},this.writeMetaDataBoolean=function(a,b){var c;for(g(this,2),this.view.setUint16(this.position,a.length),this.position+=2,c=0;c<a.length;c++)g(this,1),this.bytes[this.position]=a.charCodeAt(c),this.position++;g(this,2),this.view.setUint8(this.position,1),this.position++,this.view.setUint8(this.position,b?1:0),this.position++,this.length=Math.max(this.length,this.position),++e},this.finalize=function(){var a,c;switch(this.bytes[0]){case d.VIDEO_TAG:this.bytes[11]=7|(this.keyFrame||b?16:32),this.bytes[12]=b?0:1,a=this.pts-this.dts,this.bytes[13]=(16711680&a)>>>16,this.bytes[14]=(65280&a)>>>8,this.bytes[15]=(255&a)>>>0;break;case d.AUDIO_TAG:this.bytes[11]=175,this.bytes[12]=b?0:1;break;case d.METADATA_TAG:this.position=11,this.view.setUint8(this.position,2),this.position++,this.view.setUint16(this.position,10),this.position+=2,this.bytes.set([111,110,77,101,116,97,68,97,116,97],this.position),this.position+=10,this.bytes[this.position]=8,this.position++,this.view.setUint32(this.position,e),this.position=this.length,this.bytes.set([0,0,9],this.position),this.position+=3,this.length=this.position}return c=this.length-11,this.bytes[1]=(16711680&c)>>>16,this.bytes[2]=(65280&c)>>>8,this.bytes[3]=(255&c)>>>0,this.bytes[4]=(16711680&this.dts)>>>16,this.bytes[5]=(65280&this.dts)>>>8,this.bytes[6]=(255&this.dts)>>>0,this.bytes[7]=(4278190080&this.dts)>>>24,this.bytes[8]=0,this.bytes[9]=0,this.bytes[10]=0,g(this,4),this.view.setUint32(this.length,this.length),this.length+=4,this.position+=4,this.bytes=this.bytes.subarray(0,this.length),this.frameTime=d.frameTime(this.bytes),this}},d.AUDIO_TAG=8,d.VIDEO_TAG=9,d.METADATA_TAG=18,d.isAudioFrame=function(a){return d.AUDIO_TAG===a[0]},d.isVideoFrame=function(a){return d.VIDEO_TAG===a[0]},d.isMetaData=function(a){return d.METADATA_TAG===a[0]},d.isKeyFrame=function(a){return d.isVideoFrame(a)?23===a[11]:!!d.isAudioFrame(a)||!!d.isMetaData(a)},d.frameTime=function(a){var b=a[4]<<16;return b|=a[5]<<8,b|=a[6]<<0,b|=a[7]<<24},b.exports=d},{}],6:[function(a,b,c){b.exports={tag:a("./flv-tag"),Transmuxer:a("./transmuxer"),tools:a("../tools/flv-inspector")}},{"../tools/flv-inspector":19,"./flv-tag":5,"./transmuxer":7}],7:[function(a,b,c){"use strict";var d,e,f,g,h,i,j,k=a("../utils/stream.js"),l=a("./flv-tag.js"),m=a("../m2ts/m2ts.js"),n=a("../codecs"),o=n.adts,p=n.h264.H264Stream;h=function(a,b){"number"==typeof b.pts&&(void 0===a.timelineStartInfo.pts?a.timelineStartInfo.pts=b.pts:a.timelineStartInfo.pts=Math.min(a.timelineStartInfo.pts,b.pts)),"number"==typeof b.dts&&(void 0===a.timelineStartInfo.dts?a.timelineStartInfo.dts=b.dts:a.timelineStartInfo.dts=Math.min(a.timelineStartInfo.dts,b.dts))},i=function(a,b){var c=new l(l.METADATA_TAG);return c.dts=b,c.pts=b,c.writeMetaDataDouble("videocodecid",7),c.writeMetaDataDouble("width",a.width),c.writeMetaDataDouble("height",a.height),c},j=function(a,b){var c,d=new l(l.VIDEO_TAG,!0);for(d.dts=b,d.pts=b,d.writeByte(1),d.writeByte(a.profileIdc),d.writeByte(a.profileCompatibility),d.writeByte(a.levelIdc),d.writeByte(255),d.writeByte(225),d.writeShort(a.sps[0].length),d.writeBytes(a.sps[0]),d.writeByte(a.pps.length),c=0;c<a.pps.length;++c)d.writeShort(a.pps[c].length),d.writeBytes(a.pps[c]);return d},f=function(a){var b,c=[];f.prototype.init.call(this),this.push=function(b){h(a,b),a&&void 0===a.channelcount&&(a.audioobjecttype=b.audioobjecttype,a.channelcount=b.channelcount,a.samplerate=b.samplerate,a.samplingfrequencyindex=b.samplingfrequencyindex,a.samplesize=b.samplesize,a.extraData=a.audioobjecttype<<11|a.samplingfrequencyindex<<7|a.channelcount<<3),b.pts=Math.round(b.pts/90),b.dts=Math.round(b.dts/90),c.push(b)},this.flush=function(){var d,e,f,g=[];if(0===c.length)return void this.trigger("done");for(f=-(1/0);c.length;)d=c.shift(),(a.extraData!==b||d.pts-f>=1e3)&&(e=new l(l.METADATA_TAG),e.pts=d.pts,e.dts=d.dts,e.writeMetaDataDouble("audiocodecid",10),e.writeMetaDataBoolean("stereo",2===a.channelcount),e.writeMetaDataDouble("audiosamplerate",a.samplerate),e.writeMetaDataDouble("audiosamplesize",16),g.push(e),b=a.extraData,e=new l(l.AUDIO_TAG,!0),e.pts=d.pts,e.dts=d.dts,e.view.setUint16(e.position,a.extraData),e.position+=2,e.length=Math.max(e.length,e.position),g.push(e),f=d.pts),e=new l(l.AUDIO_TAG),e.pts=d.pts,e.dts=d.dts,e.writeBytes(d.data),g.push(e);b=null,this.trigger("data",{track:a,tags:g}),this.trigger("done")}},f.prototype=new k,e=function(a){var b,c,d=[];e.prototype.init.call(this),this.finishFrame=function(c,d){d&&(b&&a&&a.newMetadata&&(d.keyFrame||0===c.length)&&(c.push(i(b,d.pts)),c.push(j(a,d.pts)),a.newMetadata=!1),d.endNalUnit(),c.push(d))},this.push=function(b){h(a,b),b.pts=Math.round(b.pts/90),b.dts=Math.round(b.dts/90),d.push(b)},this.flush=function(){for(var e,f=[];d.length&&d[0].nalUnitType!==n.h264.unitTypes.access_unit_delimiter_rbsp;)d.shift();if(0===d.length)return void this.trigger("done");for(;d.length;){switch(e=d.shift(),e.nalUnitType){case n.h264.unitTypes.seq_parameter_set_rbsp:a.newMetadata=!0,b=e.config,a.width=b.width,a.height=b.height,a.sps=[e.data],a.profileIdc=b.profileIdc,a.levelIdc=b.levelIdc,a.profileCompatibility=b.profileCompatibility,c.endNalUnit();break;case n.h264.unitTypes.pic_parameter_set_rbsp:a.newMetadata=!0,a.pps=[e.data],c.endNalUnit();break;case n.h264.unitTypes.access_unit_delimiter_rbsp:c&&this.finishFrame(f,c),c=new l(l.VIDEO_TAG),c.pts=e.pts,c.dts=e.dts;break;case n.h264.unitTypes.slice_layer_without_partitioning_rbsp_idr:c.keyFrame=!0,c.endNalUnit();break;default:c.endNalUnit()}c.startNalUnit(),c.writeBytes(e.data)}c&&this.finishFrame(f,c),this.trigger("data",{track:a,tags:f}),this.trigger("done")}},e.prototype=new k,g=function(a){this.numberOfTracks=0,this.metadataStream=a.metadataStream,this.videoTags=[],this.audioTags=[],this.videoTrack=null,this.audioTrack=null,this.pendingCaptions=[],this.pendingMetadata=[],this.pendingTracks=0,g.prototype.init.call(this),this.push=function(a){return a.text?this.pendingCaptions.push(a):a.frames?this.pendingMetadata.push(a):("video"===a.track.type&&(this.videoTrack=a.track,this.videoTags=a.tags,this.pendingTracks++),void("audio"===a.track.type&&(this.audioTrack=a.track,this.audioTags=a.tags,this.pendingTracks++)))}},g.prototype=new k,g.prototype.flush=function(){var a,b,c,d,e={tags:{},captions:[],metadata:[]};if(!(this.pendingTracks<this.numberOfTracks)){for(this.videoTrack?d=this.videoTrack.timelineStartInfo.pts:this.audioTrack&&(d=this.audioTrack.timelineStartInfo.pts),e.tags.videoTags=this.videoTags,e.tags.audioTags=this.audioTags,c=0;c<this.pendingCaptions.length;c++)b=this.pendingCaptions[c],b.startTime=b.startPts-d,b.startTime/=9e4,b.endTime=b.endPts-d,b.endTime/=9e4,e.captions.push(b);for(c=0;c<this.pendingMetadata.length;c++)a=this.pendingMetadata[c],a.cueTime=a.pts-d,a.cueTime/=9e4,e.metadata.push(a);e.metadata.dispatchType=this.metadataStream.dispatchType,this.videoTrack=null,this.audioTrack=null,this.videoTags=[],this.audioTags=[],this.pendingCaptions.length=0,this.pendingMetadata.length=0,this.pendingTracks=0,this.trigger("data",e),this.trigger("done")}},d=function(a){var b,c,h,i,j,k,n,q,r,s=this;d.prototype.init.call(this),a=a||{},this.metadataStream=new m.MetadataStream,a.metadataStream=this.metadataStream,b=new m.TransportPacketStream,c=new m.TransportParseStream,h=new m.ElementaryStream,i=new o,j=new p,r=new g(a),b.pipe(c).pipe(h),h.pipe(j),h.pipe(i),h.pipe(this.metadataStream).pipe(r),q=new m.CaptionStream,j.pipe(q).pipe(r),h.on("data",function(a){var b,c,d;if("metadata"===a.type){for(b=a.tracks.length;b--;)"video"===a.tracks[b].type?c=a.tracks[b]:"audio"===a.tracks[b].type&&(d=a.tracks[b]);c&&!k&&(r.numberOfTracks++,k=new e(c),j.pipe(k).pipe(r)),d&&!n&&(r.numberOfTracks++,n=new f(d),i.pipe(n).pipe(r))}}),this.push=function(a){b.push(a)},this.flush=function(){b.flush()},r.on("data",function(a){s.trigger("data",a)}),r.on("done",function(){s.trigger("done")}),this.getFlvHeader=function(a,b,c){var d,e,f,g=new Uint8Array(9),h=new DataView(g.buffer);return a=a||0,b=void 0===b||b,c=void 0===c||c,h.setUint8(0,70),h.setUint8(1,76),h.setUint8(2,86),h.setUint8(3,1),h.setUint8(4,(b?4:0)|(c?1:0)),h.setUint32(5,g.byteLength),a<=0?(e=new Uint8Array(g.byteLength+4),e.set(g),e.set([0,0,0,0],g.byteLength),e):(d=new l(l.METADATA_TAG),d.pts=d.dts=0,d.writeMetaDataDouble("duration",a),f=d.finalize().length,e=new Uint8Array(g.byteLength+f),e.set(g),e.set(h.byteLength,f),e)}},d.prototype=new k,b.exports=d},{"../codecs":4,"../m2ts/m2ts.js":11,"../utils/stream.js":22,"./flv-tag.js":5}],8:[function(a,b,c){"use strict";var d={codecs:a("./codecs"),mp4:a("./mp4"),flv:a("./flv"),mp2t:a("./m2ts")};b.exports=d},{"./codecs":4,"./flv":6,"./m2ts":10,"./mp4":15}],9:[function(a,b,c){"use strict";var d=a("../utils/stream"),e=a("../codecs"),f=function(a){for(var b=0,c={payloadType:-1,payloadSize:0},d=0,e=0;b<a.byteLength&&128!==a[b];){for(;255===a[b];)d+=255,b++;for(d+=a[b++];255===a[b];)e+=255,b++;if(e+=a[b++],!c.payload&&4===d){c.payloadType=d,c.payloadSize=e,c.payload=a.subarray(b,b+e);break}b+=e,d=0,e=0}return c},g=function(a){return 181!==a.payload[0]?null:49!=(a.payload[1]<<8|a.payload[2])?null:"GA94"!==String.fromCharCode(a.payload[3],a.payload[4],a.payload[5],a.payload[6])?null:3!==a.payload[7]?null:a.payload.subarray(8,a.payload.length-1)},h=function(a,b){var c,d,e,f,g=[];if(!(64&b[0]))return g;for(d=31&b[0],c=0;c<d;c++)e=3*c,f={type:3&b[e+2],pts:a},4&b[e+2]&&(f.ccData=b[e+3]<<8|b[e+4],g.push(f));return g},i=function(){i.prototype.init.call(this),this.captionPackets_=[],this.field1_=new m,this.field1_.on("data",this.trigger.bind(this,"data")),this.field1_.on("done",this.trigger.bind(this,"done"))};i.prototype=new d,i.prototype.push=function(a){var b,c;a.nalUnitType===e.h264.unitTypes.sei_rbsp&&(b=f(a.escapedRBSP),4===b.payloadType&&(c=g(b))&&(this.captionPackets_=this.captionPackets_.concat(h(a.pts,c))))},i.prototype.flush=function(){if(!this.captionPackets_.length)return void this.field1_.flush();this.captionPackets_.sort(function(a,b){return a.pts-b.pts}),this.captionPackets_.forEach(this.field1_.push,this.field1_),this.captionPackets_.length=0,this.field1_.flush()};var j={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608},k=function(a){return null===a?"":(a=j[a]||a,String.fromCharCode(a))},l=function(){for(var a=[],b=15;b--;)a.push("");return a},m=function(){m.prototype.init.call(this),this.mode_="popOn",this.topRow_=0,this.startPts_=0,this.displayed_=l(),this.nonDisplayed_=l(),this.lastControlCode_=null,this.push=function(a){if(0===a.type){var b,c,d,e;if((b=32639&a.ccData)===this.lastControlCode_)return void(this.lastControlCode_=null);switch(this.lastControlCode_=4096==(61440&b)?b:null,b){case 0:break;case 5152:this.mode_="popOn";break;case 5167:this.flushDisplayed(a.pts),c=this.displayed_,this.displayed_=this.nonDisplayed_,this.nonDisplayed_=c,this.startPts_=a.pts;break;case 5157:this.topRow_=13,this.mode_="rollUp";break;case 5158:this.topRow_=12,this.mode_="rollUp";break;case 5159:this.topRow_=11,this.mode_="rollUp";break;case 5165:this.flushDisplayed(a.pts),this.shiftRowsUp_(),this.startPts_=a.pts;break;case 5153:"popOn"===this.mode_?this.nonDisplayed_[14]=this.nonDisplayed_[14].slice(0,-1):this.displayed_[14]=this.displayed_[14].slice(0,-1);break;case 5164:this.flushDisplayed(a.pts),this.displayed_=l();break;case 5166:this.nonDisplayed_=l();break;default:if(d=b>>>8,e=255&b,d>=16&&d<=23&&e>=64&&e<=127&&(16!==d||e<96)&&(d=32,e=null),(17===d||25===d)&&e>=48&&e<=63&&(d=9834,e=""),16==(240&d))return;this[this.mode_](a.pts,d,e)}}}};m.prototype=new d,m.prototype.flushDisplayed=function(a){var b=this.displayed_.map(function(a){return a.trim()}).filter(function(a){return a.length}).join("\n");b.length&&this.trigger("data",{startPts:this.startPts_,endPts:a,text:b})},m.prototype.popOn=function(a,b,c){var d=this.nonDisplayed_[14];d+=k(b),d+=k(c),this.nonDisplayed_[14]=d},m.prototype.rollUp=function(a,b,c){var d=this.displayed_[14];""===d&&(this.flushDisplayed(a),this.startPts_=a),d+=k(b),d+=k(c),this.displayed_[14]=d},m.prototype.shiftRowsUp_=function(){var a;for(a=0;a<this.topRow_;a++)this.displayed_[a]="";for(a=this.topRow_;a<14;a++)this.displayed_[a]=this.displayed_[a+1];this.displayed_[14]=""},b.exports={CaptionStream:i,Cea608Stream:m}},{"../codecs":4,"../utils/stream":22}],10:[function(a,b,c){b.exports=a("./m2ts")},{"./m2ts":11}],11:[function(a,b,c){"use strict";var d,e,f,g=a("../utils/stream.js"),h=a("./caption-stream"),i=a("./stream-types"),j=a("./timestamp-rollover-stream").TimestampRolloverStream,k=a("./stream-types.js");d=function(){var a=new Uint8Array(188),b=0;d.prototype.init.call(this),this.push=function(c){var d,e=0,f=188;for(b?(d=new Uint8Array(c.byteLength+b),d.set(a.subarray(0,b)),d.set(c,b),b=0):d=c;f<d.byteLength;)71!==d[e]||71!==d[f]?(e++,f++):(this.trigger("data",d.subarray(e,f)),e+=188,f+=188);e<d.byteLength&&(a.set(d.subarray(e),0),b=d.byteLength-e)},this.flush=function(){188===b&&71===a[0]&&(this.trigger("data",a),b=0),this.trigger("done")}},d.prototype=new g,e=function(){var a,b,c,d;e.prototype.init.call(this),d=this,this.packetsWaitingForPmt=[],this.programMapTable=void 0,a=function(a,d){var e=0;d.payloadUnitStartIndicator&&(e+=a[e]+1),"pat"===d.type?b(a.subarray(e),d):c(a.subarray(e),d)},b=function(a,b){b.section_number=a[7],b.last_section_number=a[8],d.pmtPid=(31&a[10])<<8|a[11],b.pmtPid=d.pmtPid},c=function(a,b){var c,e,f,g;if(1&a[5]){for(d.programMapTable={},c=(15&a[1])<<8|a[2],e=3+c-4,f=(15&a[10])<<8|a[11],g=12+f;g<e;)d.programMapTable[(31&a[g+1])<<8|a[g+2]]=a[g],g+=5+((15&a[g+3])<<8|a[g+4]);for(b.programMapTable=d.programMapTable;d.packetsWaitingForPmt.length;)d.processPes_.apply(d,d.packetsWaitingForPmt.shift())}},this.push=function(b){var c={},d=4;c.payloadUnitStartIndicator=!!(64&b[1]),c.pid=31&b[1],c.pid<<=8,c.pid|=b[2],(48&b[3])>>>4>1&&(d+=b[d]+1),0===c.pid?(c.type="pat",a(b.subarray(d),c),this.trigger("data",c)):c.pid===this.pmtPid?(c.type="pmt",a(b.subarray(d),c),this.trigger("data",c)):void 0===this.programMapTable?this.packetsWaitingForPmt.push([b,d,c]):this.processPes_(b,d,c)},this.processPes_=function(a,b,c){c.streamType=this.programMapTable[c.pid],c.type="pes",c.data=a.subarray(b),this.trigger("data",c)}},e.prototype=new g,e.STREAM_TYPES={h264:27,adts:15},f=function(){var a=this,b={data:[],size:0},c={data:[],size:0},d={data:[],size:0},e=function(a,b){function c(a,b){var c=536870912*(14&a[b])+4194304*(255&a[b+1])+16384*(254&a[b+2])+128*(255&a[b+3])+(254&a[b+4])/2;return c>4294967295&&(c-=8589934592),c}var d;b.dataAlignmentIndicator=0!=(4&a[6]),d=a[7],192&d&&(b.pts=c(a,9),b.dts=64&d?c(a,14):b.pts),b.data=a.subarray(9+a[8])},g=function(b,c){var d,f=new Uint8Array(b.size),g={type:c},h=0;if(b.data.length){for(g.trackId=b.data[0].pid;b.data.length;)d=b.data.shift(),f.set(d.data,h),h+=d.data.byteLength;e(f,g),b.size=0,a.trigger("data",g)}};f.prototype.init.call(this),this.push=function(e){({pat:function(){},pes:function(){var a,f;switch(e.streamType){case i.H264_STREAM_TYPE:case k.H264_STREAM_TYPE:a=b,f="video";break;case i.ADTS_STREAM_TYPE:a=c,f="audio";break;case i.METADATA_STREAM_TYPE:a=d,f="timed-metadata";break;default:return}e.payloadUnitStartIndicator&&g(a,f),a.data.push(e),a.size+=e.data.byteLength},pmt:function(){var b,c,d={type:"metadata",tracks:[]},f=e.programMapTable;for(b in f)f.hasOwnProperty(b)&&(c={timelineStartInfo:{baseMediaDecodeTime:0}},c.id=+b,f[b]===k.H264_STREAM_TYPE?(c.codec="avc",c.type="video"):f[b]===k.ADTS_STREAM_TYPE&&(c.codec="adts",c.type="audio"),d.tracks.push(c));a.trigger("data",d)}})[e.type]()},this.flush=function(){g(b,"video"),g(c,"audio"),g(d,"timed-metadata"),this.trigger("done")}},f.prototype=new g;var l={PAT_PID:0,MP2T_PACKET_LENGTH:188,TransportPacketStream:d,TransportParseStream:e,ElementaryStream:f,TimestampRolloverStream:j,CaptionStream:h.CaptionStream,Cea608Stream:h.Cea608Stream,MetadataStream:a("./metadata-stream")};for(var m in i)i.hasOwnProperty(m)&&(l[m]=i[m]);b.exports=l},{"../utils/stream.js":22,"./caption-stream":9,"./metadata-stream":12,"./stream-types":13,"./stream-types.js":13,"./timestamp-rollover-stream":14}],12:[function(a,b,c){"use strict";var d,e=a("../utils/stream"),f=a("./stream-types"),g=function(a,b,c){var d,e="";for(d=b;d<c;d++)e+="%"+("00"+a[d].toString(16)).slice(-2);return e},h=function(a,b,c){return decodeURIComponent(g(a,b,c))},i=function(a,b,c){return unescape(g(a,b,c))},j=function(a){return a[0]<<21|a[1]<<14|a[2]<<7|a[3]},k={TXXX:function(a){var b;if(3===a.data[0]){for(b=1;b<a.data.length;b++)if(0===a.data[b]){a.description=h(a.data,1,b),a.value=h(a.data,b+1,a.data.length-1);break}a.data=a.value}},WXXX:function(a){var b;if(3===a.data[0])for(b=1;b<a.data.length;b++)if(0===a.data[b]){a.description=h(a.data,1,b),a.url=h(a.data,b+1,a.data.length);break}},PRIV:function(a){var b;for(b=0;b<a.data.length;b++)if(0===a.data[b]){a.owner=i(a.data,0,b);break}a.privateData=a.data.subarray(b+1),a.data=a.privateData}};d=function(a){var b,c={debug:!(!a||!a.debug),descriptor:a&&a.descriptor},e=0,g=[],h=0;if(d.prototype.init.call(this),this.dispatchType=f.METADATA_STREAM_TYPE.toString(16),c.descriptor)for(b=0;b<c.descriptor.length;b++)this.dispatchType+=("00"+c.descriptor[b].toString(16)).slice(-2);this.push=function(a){var b,d,f,i,l,m;if("timed-metadata"===a.type){if(a.dataAlignmentIndicator&&(h=0,g.length=0),0===g.length&&(a.data.length<10||a.data[0]!=="I".charCodeAt(0)||a.data[1]!=="D".charCodeAt(0)||a.data[2]!=="3".charCodeAt(0)))return void(c.debug&&console.log("Skipping unrecognized metadata packet"));if(g.push(a),h+=a.data.byteLength,1===g.length&&(e=j(a.data.subarray(6,10)),e+=10),!(h<e)){for(b={data:new Uint8Array(e),frames:[],pts:g[0].pts,dts:g[0].dts},l=0;l<e;)b.data.set(g[0].data.subarray(0,e-l),l),l+=g[0].data.byteLength,h-=g[0].data.byteLength,g.shift();d=10,64&b.data[5]&&(d+=4,d+=j(b.data.subarray(10,14)),e-=j(b.data.subarray(16,20)));do{if((f=j(b.data.subarray(d+4,d+8)))<1)return console.log("Malformed ID3 frame encountered. Skipping metadata parsing.");if(m=String.fromCharCode(b.data[d],b.data[d+1],b.data[d+2],b.data[d+3]),i={id:m,data:b.data.subarray(d+10,d+f+10)},i.key=i.id,k[i.id]&&(k[i.id](i),"com.apple.streaming.transportStreamTimestamp"===i.owner)){var n=i.data,o=(1&n[3])<<30|n[4]<<22|n[5]<<14|n[6]<<6|n[7]>>>2;o*=4,o+=3&n[7],i.timeStamp=o,this.trigger("timestamp",i)}b.frames.push(i),d+=10,d+=f}while(d<e);this.trigger("data",b)}}}},d.prototype=new e,b.exports=d},{"../utils/stream":22,"./stream-types":13}],13:[function(a,b,c){"use strict";b.exports={H264_STREAM_TYPE:27,ADTS_STREAM_TYPE:15,METADATA_STREAM_TYPE:21}},{}],14:[function(a,b,c){"use strict";var d=a("../utils/stream"),e=function(a,b){var c=1;for(a>b&&(c=-1);Math.abs(b-a)>4294967296;)a+=8589934592*c;return a},f=function(a){var b,c;f.prototype.init.call(this),this.type_=a,this.push=function(a){a.type===this.type_&&(void 0===c&&(c=a.dts),a.dts=e(a.dts,c),a.pts=e(a.pts,c),b=a.dts,this.trigger("data",a))},this.flush=function(){c=b,this.trigger("done")}};f.prototype=new d,b.exports={TimestampRolloverStream:f,handleRollover:e}},{"../utils/stream":22}],15:[function(a,b,c){b.exports={generator:a("./mp4-generator"),Transmuxer:a("./transmuxer").Transmuxer,AudioSegmentStream:a("./transmuxer").AudioSegmentStream,VideoSegmentStream:a("./transmuxer").VideoSegmentStream,tools:a("../tools/mp4-inspector"),MP4ParserStream:a("./mp4-parser").MP4ParserStream,MP4BuilderStream:a("./mp4-parser").MP4BuilderStream}},{"../tools/mp4-inspector":20,"./mp4-generator":16,"./mp4-parser":17,"./transmuxer":18}],16:[function(a,b,c){"use strict";function d(a){return[a>>>24&255,a>>>16&255,a>>>8&255,255&a]}function e(a){return[a>>>8&255,255&a]}var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V=Math.pow(2,32)-1;T=window.Uint8Array,U=window.DataView,function(){var a;if(F={avc1:[],avcC:[],btrt:[],cslg:[],dinf:[],dref:[],edts:[],elst:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],mvex:[],mvhd:[],sdtp:[],smhd:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],styp:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trep:[],trex:[],tkhd:[],vmhd:[]},void 0!==T){for(a in F)F.hasOwnProperty(a)&&(F[a]=[a.charCodeAt(0),a.charCodeAt(1),a.charCodeAt(2),a.charCodeAt(3)]);G=new T(["i".charCodeAt(0),"s".charCodeAt(0),"o".charCodeAt(0),"m".charCodeAt(0)]),I=new T(["a".charCodeAt(0),"v".charCodeAt(0),"c".charCodeAt(0),"1".charCodeAt(0)]),H=new T([0,0,0,1]),J=new T([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),K=new T([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]),L={video:J,audio:K},O=new T([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),N=new T([0,0,0,0,0,0,0,0]),P=new T([0,0,0,0,0,0,0,0]),Q=P,R=new T([0,0,0,0,0,0,0,0,0,0,0,0]),S=P,M=new T([0,0,0,1,0,0,0,0,0,0,0,0])}}(),f=function(a){var b,c,d,e=[],f=0;for(b=1;b<arguments.length;b++)e.push(arguments[b]);for(b=e.length;b--;)f+=e[b].byteLength;for(c=new T(f+8),d=new U(c.buffer,c.byteOffset,c.byteLength),d.setUint32(0,c.byteLength),c.set(a,4),b=0,f=8;b<e.length;b++)c.set(e[b],f),f+=e[b].byteLength;return c},g=function(a){var b={};for(var c in a)b[c]=a[c]>>>0;return f(F.cslg,new T([0,0,0,0,b.ctts_shift>>>24&255,b.ctts_shift>>>16&255,b.ctts_shift>>>8&255,255&b.ctts_shift,b.min_ctts>>>24&255,b.min_ctts>>>16&255,b.min_ctts>>>8&255,255&b.min_ctts,b.max_ctts>>>24&255,b.max_ctts>>>16&255,b.max_ctts>>>8&255,255&b.max_ctts,b.min_cts>>>24&255,b.min_cts>>>16&255,b.min_cts>>>8&255,255&b.min_cts,b.max_cts>>>24&255,b.max_cts>>>16&255,b.max_cts>>>8&255,255&b.max_cts]))},h=function(){return f(F.dinf,f(F.dref,O))},k=function(a){return f(F.edts,l(a))},l=function(a){var b,c=a.edit_list.length,g=[0,0,0,0].concat(d(c));for(b=0;b<c;b++)g=g.concat(d(a.edit_list[b].segment_duration)).concat(d(a.edit_list[b].media_time)).concat(e(a.edit_list[b].media_rate)).concat(e(0));return f(F.elst,new T(g))},i=function(a){return f(F.esds,new T([0,0,0,0,3,25,0,0,0,4,17,64,21,0,6,0,0,0,218,192,0,0,218,192,5,2,a.audioobjecttype<<3|a.samplingfrequencyindex>>>1,a.samplingfrequencyindex<<7|a.channelcount<<3,6,1,2]))},j=function(a){a=a||{};var b=a.compatible||[G,I];return b=b.slice(0),b.unshift(F.ftyp,a.major||G,H),f.apply(null,b)},x=function(a){return f(F.hdlr,L[a])},m=function(a){return f(F.mdat,a)},w=function(a){var b=new T([0,0,0,0,0,0,0,2,0,0,0,3,0,1,95,144,a.duration>>>24&255,a.duration>>>16&255,a.duration>>>8&255,255&a.duration,85,196,0,0]);return a.samplerate&&(b[12]=a.samplerate>>>24&255,b[13]=a.samplerate>>>16&255,b[14]=a.samplerate>>>8&255,b[15]=255&a.samplerate),f(F.mdhd,b)},v=function(a){return f(F.mdia,w(a),x(a.type),o(a))},n=function(a){return f(F.mfhd,new T([0,0,0,0,(4278190080&a)>>24,(16711680&a)>>16,(65280&a)>>8,255&a]))},o=function(a){return f(F.minf,"video"===a.type?f(F.vmhd,M):f(F.smhd,N),h(),z(a))},p=function(a,b,c){var d=[],e=b.length;for(c=c||{};e--;)d[e]=B(b[e],c);return f.apply(null,[F.moof,n(a)].concat(d))},q=function(a,b){var c=a.length,d=[],e=0;for(b=b||{};c--;)d[c]=t(a[c]),
b.set_duration&&(e=Math.max(e,Math.floor(9e4*a[c].duration/a[c].samplerate)));return e=b.duration||e||4294967295,f.apply(null,[F.moov,s(e)].concat(d).concat(r(a)))},r=function(a){for(var b=a.length,c=[];b--;)c[b]=D(a[b]),a[b].cslg&&a[b].cslg.max_cts&&c.push(C(a[b]));return f.apply(null,[F.mvex].concat(c))},s=function(a){var b=new T([0,0,0,0,0,0,0,1,0,0,0,2,0,1,95,144,(4278190080&a)>>24,(16711680&a)>>16,(65280&a)>>8,255&a,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return f(F.mvhd,b)},y=function(a){var b,c,d=a.samples||[],e=new T(4+d.length);for(c=0;c<d.length;c++)b=d[c].flags,e[c+4]=b.isLeading<<6|b.dependsOn<<4|b.isDependedOn<<2|b.hasRedundancy;return f(F.sdtp,e)},z=function(a){return f(F.stbl,A(a),f(F.stts,S),f(F.stsc,Q),f(F.stsz,R),f(F.stco,P))},function(){var a,b;A=function(c){return f(F.stsd,new T([0,0,0,0,0,0,0,1]),"video"===c.type?a(c):b(c))},a=function(a){var b,c=a.sps||[],d=a.pps||[],e=[],g=[];for(b=0;b<c.length;b++)e.push((65280&c[b].byteLength)>>>8),e.push(255&c[b].byteLength),e=e.concat(Array.prototype.slice.call(c[b]));for(b=0;b<d.length;b++)g.push((65280&d[b].byteLength)>>>8),g.push(255&d[b].byteLength),g=g.concat(Array.prototype.slice.call(d[b]));return f(F.avc1,new T([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,(65280&a.width)>>8,255&a.width,(65280&a.height)>>8,255&a.height,0,72,0,0,0,72,0,0,0,0,0,0,0,1,19,118,105,100,101,111,106,115,45,99,111,110,116,114,105,98,45,104,108,115,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),f(F.avcC,new T([1,a.profileIdc,a.profileCompatibility,a.levelIdc,255].concat([224|c.length]).concat(e).concat([d.length]).concat(g))),f(F.btrt,new T([0,28,156,128,0,45,198,192,0,45,198,192])))},b=function(a){return f(F.mp4a,new T([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,(65280&a.channelcount)>>8,255&a.channelcount,(65280&a.samplesize)>>8,255&a.samplesize,0,0,0,0,(65280&a.samplerate)>>8,255&a.samplerate,0,0]),i(a))}}(),u=function(a){var b=a.duration;a.samplerate&&(b=Math.floor(9e4*b/a.samplerate));var c=new T([0,0,0,7,0,0,0,0,0,0,0,0,(4278190080&a.id)>>24,(16711680&a.id)>>16,(65280&a.id)>>8,255&a.id,0,0,0,0,(4278190080&a.duration)>>24,(16711680&a.duration)>>16,(65280&a.duration)>>8,255&a.duration,0,0,0,0,0,0,0,0,0,0,0,0,+("audio"==a.type),0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,(65280&a.width)>>8,255&a.width,0,0,(65280&a.height)>>8,255&a.height,0,0]);return f(F.tkhd,c)},B=function(a,b){var c,d,e,g,h,i,j;return b=b||{},c=f(F.tfhd,new T([0,b.no_multi_init?2:0,0,58,(4278190080&a.id)>>24,(16711680&a.id)>>16,(65280&a.id)>>8,255&a.id,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0])),i=Math.floor(a.baseMediaDecodeTime/(V+1)),j=Math.floor(a.baseMediaDecodeTime%(V+1)),d=f(F.tfdt,new T([1,0,0,0,i>>>24&255,i>>>16&255,i>>>8&255,255&i,j>>>24&255,j>>>16&255,j>>>8&255,255&j])),h=92,"audio"===a.type?(e=E(a,h),f(F.traf,c,d,e)):(g=y(a),e=E(a,g.length+h),f(F.traf,c,d,e,g))},t=function(a){a.duration=a.duration||4294967295;var b=[F.trak,u(a),v(a)];return a.edit_list&&a.edit_list.length&&b.splice(2,0,k(a)),f.apply(null,b)},C=function(a){return f(F.trep,new T([0,0,0,0,(4278190080&a.id)>>24,(16711680&a.id)>>16,(65280&a.id)>>8,255&a.id]),g(a.cslg))},D=function(a){var b=new T([0,0,0,0,(4278190080&a.id)>>24,(16711680&a.id)>>16,(65280&a.id)>>8,255&a.id,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]);return"video"!==a.type&&(b[b.length-1]=0),f(F.trex,b)},E=function(a,b){var c=a.samples||[],d=function(a){return("duration"in a&&1)|("size"in a&&2)|("flags"in a&&4)|("compositionTimeOffset"in a&&8)}(c[0]||{});b+=20+4*c.length*((d>>3&1)+(d>>2&1)+(d>>1&1)+(1&d));for(var e=function(a,b,c){return[0,0,c,1,(4278190080&a.length)>>>24,(16711680&a.length)>>>16,(65280&a.length)>>>8,255&a.length,(4278190080&b)>>>24,(16711680&b)>>>16,(65280&b)>>>8,255&b]}(c,b,d),g=!1,h=0;h<c.length;h++){var i=c[h];1&d&&e.push(i.duration>>24&255,i.duration>>16&255,i.duration>>8&255,255&i.duration),2&d&&e.push(i.size>>24&255,i.size>>16&255,i.size>>8&255,255&i.size),4&d&&e.push(i.flags.isLeading<<2|i.flags.dependsOn,i.flags.isDependedOn<<6|i.flags.hasRedundancy<<4|i.flags.paddingValue<<1|i.flags.isNonSyncSample,i.flags.degradationPriority>>8&255,255&i.flags.degradationPriority),8&d&&(g=g||i.compositionTimeOffset<0,e.push(i.compositionTimeOffset>>24&255,i.compositionTimeOffset>>16&255,i.compositionTimeOffset>>8&255,255&i.compositionTimeOffset))}return e[0]=+!!g,f(F.trun,new T(e))},b.exports={ftyp:j,mdat:m,moof:p,moov:q,initSegment:function(a,b){var c,d=j(b),e=q(a,b);return c=new T(d.byteLength+e.byteLength),c.set(d),c.set(e,d.byteLength),c}}},{}],17:[function(a,b,c){"use strict";function d(a){return("0"+a.toString(16)).slice(-2)}function e(a){return String.fromCharCode(a>>24&255,a>>16&255,a>>8&255,255&a)}function f(a,b){return a.getUint32(b+4)+4294967296*a.getUint32(b)}function g(a,b){return a.getUint8(b)<128?f(a,b):a.getUint32(b+4)+4294967296*(a.getUint32(b)-4294967296)}function h(a,b,c){var d=0,e=8*c;this.read=function(c,e){for(var f=0,g=d>>3,h=7-d%8,i=0,j=a.getUint8(g+b);i<c;i++,h--)f=f<<1|j>>h&1,h||(g++,h=8,j=a.getUint8(g+b));return e||(d+=c),f},this.bits=function(){return e-d}}function i(a){var b=a.view,c=a.ptr,d="tkhd"==a.type;return a.ver?[f(b,c),f(b,c+8),b.getUint32(c+16),f(b,c+(d?24:20))]:[b.getUint32(c),b.getUint32(c+4),b.getUint32(c+8),b.getUint32(c+(d?16:12))]}function j(a,b,c,d){for(var e=0;e<c;e++)d[e]=a.getUint32(b+4*e)}var k=a("../utils/stream.js"),l=a("./mp4-generator.js"),m={vide:"video",soun:"audio"},n=["meta","mvhd","tkhd","mdhd","smhd","vmhd","dref","hdlr","stsd","esds","stts","stps","stss","ctts","stsc","stsz","stco","esds","elst","nmhd","cslg","sdtp","co64"],o=["udta","smhd","vmhd","dref","iods","btrt","pasp","clap","uuid","colr","sbgp","sgpd","gmhd","tref","nmhd","svcC","hmhd","wide","fiel","tapt","load","meta","sefd","beam"],p={trak:{name:"track_info",multi:1},edts:{name:"edit_list"},exts:{name:"edit_list"},mdia:{name:"media_box"},minf:{name:"media_info"},dinf:{name:"data_info"},stbl:{name:"sample_table"}},q=function(){};q.prototype={},q.prototype.header=function(a){for(;a.ptr+a.buffer.b_pos>=a.branch.last;)"movie_box"==a.branch._id&&(a.root.h_parsed=!0),a.branch=a.branch.parent;if(a.type=null,a.offset=8,a.buffer.b_size-a.ptr<8)return a.offset=0;if(a.size=a.view.getUint32(a.ptr),1==a.size){if(a.offset=16,a.buffer.b_size-a.ptr<16)return a.offset=0;a.size=(a.view.getUint32(a.ptr+8)<<32)+a.view.getUint32(a.ptr+12)}if(a.type=e(a.view.getUint32(a.ptr+4)),n.includes(a.type)){if(a.offset+=4,a.buffer.b_size-a.ptr<a.offset)return a.offset=0;var b=a.view.getUint8(a.ptr+a.offset-4);a.ver=b>>>24,a.flags=b&&16777215}a.size-=a.offset,a.ptr+=a.offset},q.prototype.parse=function(a){if(!this[a.type])throw new Error("Unknown box type: "+a.type);this[a.type](a)},o.forEach(function(a){q.prototype[a]=function(b){(b.branch[a]=new Uint8Array(b.size)).set(b.buffer._buff.subarray(b.ptr,b.ptr+b.size))}}),Object.keys(p).forEach(function(a){q.prototype[a]=function(b){var c=p[a];b.branch[c.name]=b.branch[c.name]||(c.multi?[]:{});var d=b.branch[c.name];c.multi&&(d.push({}),d=d[d.length-1]),d.parent=b.branch,d.last=b.buffer.b_pos+b.ptr+b.size,d._id=c.name,b.branch=d,b.size=0}}),q.prototype.moov=function(a){var b=a.branch.movie_box=a.branch.movie_box||{};b.parent=a.branch,b.last=a.buffer.b_pos+a.ptr+a.size,b._id="movie_box",a.buffer.b_pos<256?a.branch.start_hdr_sz=a.size:a.branch.end_hdr_sz=a.size,a.branch=b,a.size=0},q.prototype.ftyp=function(a){a.branch.major_brand=e(a.view.getUint32(a.ptr)),a.branch.minor_version=a.view.getUint32(a.ptr+4),a.branch.compatible=[a.branch.major_brand];for(var b=8;b<a.size;b+=4)a.branch.compatible.push(e(a.view.getUint32(a.ptr+b)))},q.prototype.mdat=function(){},q.prototype.free=function(){},q.prototype.mvhd=function(a){var b=a.view,c=a.ptr,d=a.ver?28:16,e=a.branch.mv_hdr={},f=i(a);e.creation_time=f[0],e.modification_time=f[1],e.time_scale=f[2],e.duration=f[3],c+=d,e.rate=b.getUint32(c)/65536,e.volume=b.getUint16(c+4)/256,j(a.view,c+16,9,e.matrix=[]),e.next_track=b.getUint32(c+76)},q.prototype.tkhd=function(a){var b=a.view,c=a.ptr,d=a.ver?40:28,e=a.branch.tk_hdr={},f=i(a);e.enabled=!!(1&a.flags),e.in_movie=!!(2&a.flags),e.in_preview=!!(4&a.flags),e.creation_time=f[0],e.modification_time=f[1],e.track_id=f[2],e.duration=f[3],c+=d,e.layer=b.getUint16(c),e.alternate_group=b.getUint16(c+2),e.volume=b.getInt16(c+4)/256,j(a.view,c+8,9,e.matrix=[]),e.width=b.getUint32(c+44)/65536,e.height=b.getUint32(c+48)/65536},q.prototype.mdhd=function(a){var b=a.view,c=a.ptr,d=a.ver?28:16,e=a.branch.md_hdr={},f=i(a);e.creation_time=f[0],e.modification_time=f[1],e.time_scale=f[2],e.duration=f[3];var g=b.getUint16(c+d);e.lang=String.fromCharCode(g>>10|96,g>>5&31|96,31&g|96)},q.prototype.elst=function(a){var b=a.view,c=a.ptr+4,d=b.getUint32(a.ptr);a.branch.list=[];for(var e=0;e<d;c+=4,e++){var h={};h.segment_duration=a.ver?f(b,c):b.getUint32(c),h.media_time=a.ver?g(b,c+8):b.getInt32(c+4),c+=a.ver?16:8,h.media_rate=b.getInt16(c),a.branch.list.push(h)}},q.prototype.cslg=function(a){var b=a.view,c=a.ptr;a.branch.cslg={ctts_shift:b.getInt32(c),min_ctts:b.getInt32(c+4),max_ctts:b.getInt32(c+8),min_cts:b.getInt32(c+12),max_cts:b.getInt32(c+16)}},q.prototype.hdlr=function(a){a.branch.handler=e(a.view.getUint32(a.ptr+4))},q.prototype._parse_avcc=function(a,b){var c=a.view,d=a.ptr,e=b.sps=[],f=b.pps=[];b.avc_p_i=c.getUint8(d+1),b.prof_compat=c.getUint8(d+2),b.avc_l_i=c.getUint8(d+3),b.l_size_m_1=3&c.getUint8(d+4),b.n_sps=31&c.getUint8(d+5);for(var g=6,h=0;h<b.n_sps;h++)e[h]={l:c.getUint16(d+g)},g+=2,e[h].nal=new Uint8Array(a.buffer._buff.subarray(d+g,d+g+e[h].l)),g+=e[h].l;for(b.n_pps=c.getUint8(d+g++),h=0;h<b.n_pps;h++)f[h]={l:c.getUint16(d+g)},g+=2,f[h].nal=new Uint8Array(a.buffer._buff.subarray(d+g,d+g+f[h].l)),g+=f[h].l},q.prototype._parse_esds=function(a,b){for(var c=a.view,d=a.ptr;d<a.ptr+a.size;){var e,f=c.getUint8(d++),g=0;do{e=c.getUint8(d++),g=(g<<7)+(127&e)}while(128&e);switch(f){case 3:b.es_id=c.getUint16(d);var i=c.getUint8(d+2);d+=3+(i>>6&2)+(i>>4&2);break;case 4:b.obj_t=c.getUint8(d),b.str_t=63&c.getUint8(d+1),d+=13;break;case 5:var j,k=new h(c,d,g);if(b.aot=k.read(5),31==b.aot&&(b.aot=32+k.read(6)),b.freq=k.read(4),15==b.freq&&(b.freq=k.read(24)),b.channel=k.read(4),5!=b.aot&&29!=b.aot||(j=5,15==(b.ext_freq_index=k.read(4))&&(b.ext_freq=k.read(24)),b.aot=k.read(5),31==b.aot&&(b.aot=32+k.read(6))),5!=j&&36!=b.aot)for(;k.bits()>=16;)695==k.read(11,1)?(k.read(11),5==k.read(5)&&k.read(1)&&(15==k.read(4)&&k.read(24),k.bits()>=12&&1352==k.read(11)&&1!=k.read(1)&&(b.dsi=5))):k.read(1);d+=g;break;default:d+=g}}},q.prototype.stsd=function(a){var b,c,d=a.view,e=d.getUint32(a.ptr),f=a.branch.parent.parent.handler;for(a.branch.list={},a.ptr+=4,b=0;b<e;b++){this.header(a);var g={},h=d.getUint16(a.ptr+6),i=a.ptr+a.size;switch(f){case"vide":for(g.width=d.getUint16(a.ptr+24),g.height=d.getUint16(a.ptr+26),g.h_res=d.getUint32(a.ptr+28)/65536,g.v_res=d.getUint32(a.ptr+32)/65536,g.f_count=d.getUint16(a.ptr+40),g.compressor="",c=0;c<32;c++){if(!d.getUint8(a.ptr+42+c))break;g.compressor+=String.fromCharCode()}g.depth=d.getUint16(a.ptr+74);for(var j=[1668246642,1668047216,1885434736,1718183276];j.includes(d.getUint32(a.ptr+82));)a.ptr+=d.getUint32(a.ptr+78);1635148611==d.getUint32(a.ptr+82)&&(g.avcc={},a.ptr+=78,this.header(a),this._parse_avcc(a,g.avcc));break;case"soun":for(g.c_count=d.getUint16(a.ptr+16),g.s_size=d.getUint16(a.ptr+18),g.s_rate=d.getUint32(a.ptr+24)/65536,c=32;c<a.size-12;c++)if(1702061171==d.getUint32(a.ptr+c)){g.esds={},a.ptr+=c-4,this.header(a),this._parse_esds(a,g.esds);break}}a.ptr=i,a.branch.list[h]=g}a.size=0},q.prototype.stts=function(a){var b=a.view.getUint32(a.ptr),c=a.ptr+4;a.branch.dtts=[];for(var d=0;d<b;d++)for(var e=a.view.getUint32(a.ptr+4+8*d),f=a.view.getUint32(c+8*d+4),g=0;g<e;g++)a.branch.dtts.push(f)},q.prototype.ctts=function(a){var b=a.view.getUint32(a.ptr),c=a.ptr+4;a.branch.ctts=[];for(var d=0;d<b;d++)for(var e=a.view.getUint32(c+8*d),f=a.view.getInt32(c+8*d+4),g=0;g<e;g++)a.branch.ctts.push(f)},q.prototype.stsc=function(a){for(var b=a.view.getUint32(a.ptr),c=a.branch.s_t_c=[],d=a.view,e=a.ptr+4,f=0;f<b;f++)c[f]={f_c:d.getUint32(e+12*f),s_p_c:d.getUint32(e+12*f+4),s_d_i:d.getUint32(e+12*f+8)};c.sort(function(a,b){return a.f_c-b.f_c})},q.prototype.stss=function(a){j(a.view,a.ptr+4,a.view.getUint32(a.ptr),a.branch.s_sync=[])},q.prototype.stps=function(a){j(a.view,a.ptr+4,a.view.getUint32(a.ptr),a.branch.s_psync=[])},q.prototype.sdtp=function(a){a.branch.s_dep=[];for(var b=0;b<a.size;b++){var c=a.view.getUint8(a.ptr+b);a.branch.s_dep[b]={red:3&c,is_dep:c>>2&3,dep:c>>4&3,lead:c>>6&3}}},q.prototype.stsz=function(a){var b=a.view.getUint32(a.ptr);if(a.branch.s_sz=[],a.branch.s_count=a.view.getUint32(a.ptr+4),b)for(var c=0;c<a.branch.s_count;c++)a.branch.s_sz.push(b);else j(a.view,a.ptr+8,a.branch.s_count,a.branch.s_sz)},q.prototype.stco=function(a){j(a.view,a.ptr+4,a.view.getUint32(a.ptr),a.branch.c_off=[])},q.prototype.co64=function(a){var b=a.view.getUint32(a.ptr);a.branch.c_off=[];for(var c=0;c<b;c++)a.branch.c_off[c]=f(a.view,a.ptr+4+8*c)};var r=function(a){this.conf_update(a)};r.prototype={},r.prototype.conf_update=function(a){this.break_on_count=a.break_on_count,this.frag_size=a.frag_size||10},r.prototype.process=function(a){var b={type:"metadata",tracks:[],brands:["iso5","iso6"],matrix:a.root.movie_box.mv_hdr.matrix,start_hdr_sz:a.root.start_hdr_sz,end_hdr_sz:a.root.end_hdr_sz},c=this;b.duration=Math.floor(9e4*a.root.movie_box.mv_hdr.duration/a.root.movie_box.mv_hdr.time_scale),b.timescale=9e4,b.s_info=this.s_info=[],b.s_p=this.s_p=[],a.root.movie_box.track_info.forEach(function(e){if(["vide","soun"].includes(e.media_box.handler)){var f={id:e.tk_hdr.track_id,ts:e.media_box.md_hdr.time_scale,type:e.media_box.handler,s_off:[],s_time:[],s_dri:[],s_sync:e.media_box.media_info.sample_table.s_sync||[],s_psync:e.media_box.media_info.sample_table.s_psync||[],s_sz:e.media_box.media_info.sample_table.s_sz,s_dep:e.media_box.media_info.sample_table.s_dep||[],s_ctts:e.media_box.media_info.sample_table.ctts||[],s_cslg:e.media_box.media_info.sample_table.cslg||{},s_list:e.media_box.media_info.sample_table.list};e.edit_list&&e.edit_list.list.length&&(f.elst=e.edit_list.list);for(var g=e.media_box.media_info.sample_table.c_off,h=e.media_box.media_info.sample_table.s_t_c,i=e.media_box.media_info.sample_table.dtts,j=1,k=0,l=0,n=Array.isArray(f.s_sz),o=0;o<h.length;o++)for(;j<(h[o+1]?h[o+1].f_c:g.length+1);j++)for(var p=g[j-1],q=0;q<h[o].s_p_c;q++)f.s_off[k]=p,f.s_time[k]=l,f.s_dri[k]=h[o].s_d_i,l+=i[k],p+=n?f.s_sz[k++]:f.s_sz;c.s_info.push(f),c.s_p.push({s:0,max_t:0}),"vide"==f.type&&(b.v_idx=c.v_idx=c.s_info.length-1);var r=f.s_list[1],s={id:f.id,type:m[f.type],edit_list:f.elst,cslg:f.s_cslg,dr:r,timelineStartInfo:{baseMediaDecodeTime:0},bitrate:Math.floor(8*f.s_sz.reduce(function(a,b){return a+b})*f.ts/e.media_box.md_hdr.duration),duration:"soun"==f.type?e.media_box.md_hdr.duration:Math.floor(9e4*e.media_box.md_hdr.duration/f.ts),samplerate:"soun"==f.type?f.ts:9e4,matrix:e.tk_hdr.matrix,track_width:e.tk_hdr.width,track_height:e.tk_hdr.height,nb_samples:f.s_time.length};if("soun"==f.type){var t=r.esds.dsi||r.esds.aot;s.codec="mp4a."+d(r.esds.obj_t.toString(16))+(t?"."+t:""),s.s_i=new Uint8Array([r.esds.aot<<3|r.esds.freq>>>1,r.esds.freq<<7|r.esds.channel<<3])}else{s.codec="avc1."+d(r.avcc.avc_p_i)+d(r.avcc.prof_compat)+d(r.avcc.avc_l_i);var u=[1,r.avcc.avc_p_i,r.avcc.avc_prof_compat,r.avcc.avc_l_i,255,r.avcc.sps.length+224];r.avcc.sps.forEach(function(a){u=u.concat([a.nal.length>>8,255&a.nal.length]),Array.prototype.push.apply(u,a.nal)}),u.push(r.avcc.pps.length),r.avcc.pps.forEach(function(a){u=u.concat([a.nal.length>>8,255&a.nal.length]),Array.prototype.push.apply(u,a.nal)}),s.s_i=new Uint8Array(u)}if(s.edit_list&&s.edit_list.forEach(function(b){"soun"!=f.type&&(b.media_time=Math.floor(9e4*b.media_time/f.ts)),b.segment_duration=Math.floor(9e4*b.segment_duration/a.root.movie_box.mv_hdr.time_scale)}),s.cslg)for(var v in s.cslg)s.cslg[v]=Math.floor(9e4*s.cslg[v]/f.ts);b.tracks.push(s)}}),a.stream.trigger("data",b)},r.prototype.parse=function(a){this.s_info||this.process(a);for(var b,c=a.buffer.b_pos,d=a.buffer.b_size+c,e=-1,f=0;e;)for(e=0,b=0;b<this.s_p.length;b++){var g=this.s_info[b],h=this.s_p[b].s,i=g.s_off[h],j=g.s_sz[h],k=g.s_time;if(i>=c&&i+j<=d){this.s_p[b].s++,e++;var l={trackId:g.id};l.type=m[g.type],l.dts=k[h],l.pts=l.dts+(g.s_ctts[h]||0),l.duration=h==k.length-1?k[h]-k[h-1]:k[h+1]-k[h],l.size=j,this.s_p[b].max_t=l.dts/g.ts,l.data=a.buffer._buff.subarray(i-c,i+j-c),l.dr=g.s_list[g.s_dri[h]],l.ts=g.ts,l.synced=!g.s_sync.length||g.s_sync.includes(h+1),l.sn=h,l.dep=g.s_dep[h],"vide"==g.type&&(this.break_on_count?h%this.frag_size==0:h&&l.synced)&&a.stream.flush(),a.stream.trigger("data",l),f=i+j-c}else i+j>d&&b==this.v_idx&&!0}f&&a.buffer.advance(f);var n=1/0;for(b=0;b<this.s_p.length;b++)this.s_p[b].s!=this.s_info[b].s_off.length?n=Math.min(n,this.s_info[b].s_off[this.s_p[b].s]):this.s_p[b].finish=!0;return n==1/0&&a.stream.flush(),(n==1/0||n>=c&&n<d)&&(n=d),n},r.prototype.seek=function(a,b){function c(a,b,c){var d,e,f,g,h,i,j=c&&b.s_sync.length>0,k=(b.type,b.ts/9e4);for(d=0,e=j?b.s_sync.length-1:b.s_time.length-1,i=Math.floor(a*k);d<e-1;)if(g=d+e>>1,f=j?b.s_sync[g]-1:g,(h=b.s_time[f]+(0|b.s_ctts[f]))>i)e=g;else if(d=g,h==i)break;var l=j?b.s_sync[d]-1:d;if(i=h=b.s_time[l]+(0|b.s_ctts[l]),!j&&b.s_ctts.length){for(f=d-1;f>d-10;f--)b.s_time[f]+(0|b.s_ctts[f])>i&&(l=f);for(f=l;f<d+10;f++)(h=b.s_time[f]+(0|b.s_ctts[f]))>(0|(b.s_cslg&&b.s_cslg.min_ctts))&&h<i&&(i=h)}return{sn:l,min_t:i/b.ts}}if(!this.s_info)throw new Error("No metadata information for seeking");var d=9e4*a,e=1/0;if(void 0!==this.v_idx){var f=this.s_info[this.v_idx],g=c(d,f,b),h=g.sn;this.s_p[this.v_idx].s=h,this.s_p[this.v_idx].max_t=(f.s_time[h]+(0|f.s_ctts[h]))/f.ts,d=9e4*g.min_t,e=f.s_off[h]}var i=this;return this.s_info.forEach(function(a,f){if(f!=i.v_idx){var g=c(d,a,b).sn;i.s_p[f].s=g,i.s_p[f].max_t=(a.s_time[g]+(0|a.s_ctts[g]))/a.ts,e=Math.min(a.s_off[g],e)}}),{offset:e,time:this.s_p[void 0!==this.v_idx?this.v_idx:0].max_t}};var s=function(){this._buff=new Uint8Array(3145728),this.b_pos=0,this.b_size=0,this.pos=0};s.prototype={},s.prototype.advance=function(a){this._buff.set(this._buff.subarray(a,this.b_size)),this.b_pos+=a,this.b_size-=a},s.prototype.push=function(a){for(var b,c=a.length;c+this.b_size>this._buff.length;)b=new Uint8Array(2*this._buff.length),b.set(this._buff),this._buff=b;this.pos<this.b_pos+this.b_size&&this.pos+c>=this.b_pos?(b=new Uint8Array(Math.max(this.pos+c,this.b_pos+this.b_size)-Math.min(this.pos,this.b_pos)),this.pos<=this.b_pos?(b.set(a),this.pos+c<this.b_pos+this.b_size&&b.set(this._buff.subarray(this.pos+c-this.b_pos,this.b_size),c)):(b.set(this._buff.subarray(0,this.pos-this.b_pos)),b.set(a,this.pos-this.b_pos)),this._buff.set(b),this.b_size=b.length,b=null,this.b_pos=Math.min(this.b_pos,this.pos)):this.pos==this.b_pos+this.b_size?(this._buff.set(a,this.b_size),this.b_size+=c):(this._buff.set(a),this.b_size=c,this.b_pos=this.pos),this.view=new DataView(this._buff.buffer,this._buff.byteOffset,this.b_size)};var t=function(a){if(!(this instanceof t))return new t(a);t.prototype.init.call(this),this.buffer=new s,this.b_parser=new q,this.c_parser=new r(a),this.on("confupdate",function(a){this.c_parser.conf_update(a)}),this.metadata={},this.buffer.pos=a.pos||0,a.metadata&&(this.metadata.h_parsed=!0,this.c_parser.s_info=a.metadata.s_info.slice(),this.c_parser.s_p=a.metadata.s_p.slice(),this.c_parser.v_idx=a.metadata.v_idx)};t.prototype=new k,t.prototype.constructor=t,t.prototype.get_tl=function(a){if(!this.metadata.h_parsed)throw new Error("No metadata information for time map");var b=this.c_parser.s_info.filter(function(b){return b.id==a});if(!b.length)throw new Error("No track information for time map");return{offset:b[0].s_off.slice(0),time:b[0].s_time.map(function(a){return a/b[0].ts})}},t.prototype.push=function(a){this.buffer.push(a);for(var b={root:this.metadata,branch:this.metadata,buffer:this.buffer,view:this.buffer.view,stream:this,ptr:0};!this.metadata.h_parsed&&(this.b_parser.header(b),b.type&&!(b.size+b.ptr>this.buffer.b_size));)this.b_parser.parse(b),b.ptr+=b.size;return this.metadata.h_parsed?this.buffer.pos=this.c_parser.parse(b):(this.buffer.advance(b.ptr-b.offset),this.buffer.pos="mdat"==b.type?b.ptr+b.size:this.buffer.b_pos+this.buffer.b_size),this.buffer.pos},t.prototype.seek=function(a,b){this.trigger("data",{type:"seek"});var c=this.c_parser.seek(a,b);return this.buffer.pos=c.offset,c};var u=function(){if(!(this instanceof u))return new u;u.prototype.init.call(this)};u.prototype=new k,u.prototype.constructor=u,u.prototype.push=function(a){if("audio"==a.type){var b=9e4/a.ts;a.pts=Math.floor(a.pts*b),a.dts=Math.floor(a.dts*b),this.trigger("data",{type:"audio",samplerate:a.dr.s_rate,samplesize:a.dr.s_size,audioobjecttype:a.dr.esds.aot,samplingfrequencyindex:a.dr.esds.freq,channelcount:a.dr.esds.channel,ts:a.ts,dts:a.dts,pts:a.pts,data:new Uint8Array(a.data)})}};var v=function(){if(!(this instanceof v))return new v;v.prototype.init.call(this),this.synced=!1,this.au=new Uint8Array([9,240])};v.prototype=new k,v.prototype.constructor=v,v.prototype.flush=function(){this.dr=null,this.synced=!1,this.trigger("done")},v.prototype.push=function(a){if("video"==a.type){var b,c=0,d=new DataView(a.data.buffer,a.data.byteOffset,a.data.byteLength),e=9e4/a.ts;if(a.pts=Math.floor(a.pts*e),a.dts=Math.floor(a.dts*e),this.trigger("data",{trackId:a.trackId,pts:a.pts,dts:a.dts,data:this.au,nalUnitType:"access_unit_delimiter_rbsp"}),this.dr!=a.dr||!this.synced){if(this.dr=a.dr,this.dr.avcc.n_sps)for(b=0;b<this.dr.avcc.n_sps;b++)this.trigger("data",{trackId:a.trackId,pts:a.pts,dts:a.dts,nalUnitType:"seq_parameter_set_rbsp",data:this.dr.avcc.sps[b].nal,config:{profileIdc:this.dr.avcc.avc_p_i,levelIdc:this.dr.avcc.avc_l_i,profileCompatibility:this.dr.avcc.prof_compat,width:this.dr.width,height:this.dr.height}});if(this.dr.avcc.n_pps)for(b=0;b<this.dr.avcc.n_pps;b++)this.trigger("data",{trackId:a.trackId,pts:a.pts,dts:a.dts,nalUnitType:"pic_parameter_set_rbsp",data:this.dr.avcc.pps[0].nal});this.synced=!0}for(;c<a.data.length;){var f=d.getUint32(c),g={trackId:a.trackId,pts:a.pts,dts:a.dts,data:new Uint8Array(a.data.subarray(c+4,c+f+4))};5==(31&g.data[0])&&(g.nalUnitType="slice_layer_without_partitioning_rbsp_idr"),g.synced=!c&&a.synced,c+=f+4,this.trigger("data",g)}}};var w=function(a){if(!(this instanceof w))return new w(a);w.prototype.init.call(this),this.options=a||{},this.tracks={},this.options.no_multi_init=!0,this.options.major=new Uint8Array([105,115,111,53]),this.options.compatible=[new Uint8Array([105,115,111,54])],this.options.set_duration=!0,this.on("confupdate",function(a){this.options.break_on_count=a.break_on_count}),this.metadata=a.metadata,this.inited=!!this.metadata};w.prototype=new k,w.prototype.constructor=w,w.prototype.push=function(a){var b;if("metadata"==a.type)return void(this.metadata=a);if("seek"!=a.type){b=a.trackId,this.tracks[b]=this.tracks[b]||{samples:[],seqno:0,sc:0,type:a.type};var c={duration:a.duration,size:a.size,dts:a.dts,pts:a.pts,data:new Uint8Array(a.data),sn:a.sn};if("video"==a.type){var d=9e4/a.ts;c.duration=Math.floor(c.duration*d),c.pts=Math.floor(c.pts*d),c.dts=Math.floor(c.dts*d),c.flags={dependsOn:0|(c.dep&&c.dep.dep),isDependedOn:0|(c.dep&&c.dep.is_dep),hasRedundancy:0|(c.dep&&c.dep.red)||2*a.synced,isLeading:0|(c.dep&&c.dep.lead)},this.options.break_on_count||(c.flags.isNonSyncSample=+!a.synced),c.compositionTimeOffset=c.pts-c.dts}a.data=null,this.tracks[b].samples.push(c)}else for(b in this.tracks)this.tracks[b].samples=[]},w.prototype.flush=function(){var a,b,c,d=this;if(!this.inited){this.inited=!0;var e=[];this.metadata.tracks.forEach(function(a){switch(a.type){case"video":a.profileIdc=a.dr.avcc.avc_p_i,a.levelIdc=a.dr.avcc.avc_l_i,a.profileCompatibility=a.dr.avcc.prof_compat,a.width=a.track_width,a.height=a.track_height,a.sps=a.dr.avcc.sps.map(function(a){return a.nal}),a.pps=a.dr.avcc.pps.map(function(a){return a.nal});break;case"audio":a.samplesize=a.dr.s_size,a.audioobjecttype=a.dr.esds.aot,a.samplingfrequencyindex=a.dr.esds.freq,a.channelcount=a.dr.esds.channel}e.push({id:a.id,buffer:l.initSegment([a],d.options)})}),this.trigger("data",{init:!0,inits:e})}for(var f in this.tracks){var g=this.tracks[f];if(g.samples.length){var h=g.samples;c=h.reduce(function(a,b){return a+b.data.length},0),a=l.moof(++g.seqno,[{id:f,baseMediaDecodeTime:h[0].dts,samples:h,type:g.type}],d.options);for(var i=new Uint8Array(8+c+a.length),j=new Uint8Array(c),k=0,m=0;m<h.length;m++)j.set(h[m].data,k),k+=h[m].data.length;b=l.mdat(j),i.set(a),i.set(b,a.length),i.sn=h[h.length-1].sn,j=b=a=null,this.tracks[f].sc+=h.length,this.trigger("data",{id:f,data:i,sc:this.tracks[f].sc}),this.tracks[f].samples=[]}}this.trigger("done")},b.exports={MP4ParserStream:t,AudioFilterStream:u,VideoFilterStream:v,MP4BuilderStream:w}},{"../utils/stream.js":22,"./mp4-generator.js":16}],18:[function(a,b,c){"use strict";var d,e,f,g,h,i,j,k,l,m,n,o=a("../utils/stream.js"),p=a("./mp4-generator.js"),q=a("./mp4-parser.js"),r=a("../m2ts/m2ts.js"),s=a("../codecs"),t=s.adts,u=s.h264.H264Stream,v=a("../aac"),w=["audioobjecttype","channelcount","samplerate","samplingfrequencyindex","samplesize"],x=["width","height","profileIdc","levelIdc","profileCompatibility"];h=function(){return{size:0,flags:{isLeading:0,dependsOn:1,isDependedOn:0,hasRedundancy:0,degradationPriority:0}}},i=function(a){return a[0]==="I".charCodeAt(0)&&a[1]==="D".charCodeAt(0)&&a[2]==="3".charCodeAt(0)},m=function(a,b){var c;if(a.length!==b.length)return!1;for(c=0;c<a.length;c++)if(a[c]!==b[c])return!1;return!0},n=function(a){var b,c,d=0;for(b=0;b<a.length;b++)c=a[b],d+=c.data.byteLength;return d},e=function(a){var b=[],c=0,d=0;e.prototype.init.call(this),this.push=function(c){j(a,c),a&&w.forEach(function(b){a[b]=c[b]}),b.push(c)},this.setEarliestDts=function(b){d=b-a.timelineStartInfo.baseMediaDecodeTime},this.flush=function(){var d,e,f,g;if(0===b.length)return void this.trigger("done","AudioSegmentStream");d=this.trimAdtsFramesByEarliestDts_(b),a.samples=this.generateSampleTable_(d),f=p.mdat(this.concatenateFrameData_(d)),b=[],l(a),e=p.moof(c,[a]),g=new Uint8Array(e.byteLength+f.byteLength),c++,g.set(e),g.set(f,e.byteLength),k(a),this.trigger("data",{track:a,boxes:g}),this.trigger("done","AudioSegmentStream")},this.trimAdtsFramesByEarliestDts_=function(b){return a.minSegmentDts>=d?b:(a.minSegmentDts=1/0,b.filter(function(b){return b.dts>=d&&(a.minSegmentDts=Math.min(a.minSegmentDts,b.dts),a.minSegmentPts=a.minSegmentDts,!0)}))},this.generateSampleTable_=function(a){var b,c,d=[];for(b=0;b<a.length;b++)c=a[b],d.push({size:c.data.byteLength,duration:1024});return d},this.concatenateFrameData_=function(a){var b,c,d=0,e=new Uint8Array(n(a));for(b=0;b<a.length;b++)c=a[b],e.set(c.data,d),d+=c.data.byteLength;return e}},e.prototype=new o,d=function(a){var b,c,e=0,f=[];d.prototype.init.call(this),delete a.minPTS,this.gopCache_=[],this.push=function(d){j(a,d),d.nalUnitType!==s.h264.unitTypes.seq_parameter_set_rbsp||b||(b=d.config,a.sps=[d.data],x.forEach(function(c){a[c]=b[c]},this)),d.nalUnitType!==s.h264.unitTypes.pic_parameter_set_rbsp||c||(c=d.data,a.pps=[d.data]),f.push(d)},this.flush=function(){for(var b,c,d,g,h,i;f.length&&f[0].nalUnitType!==s.h264.unitTypes.access_unit_delimiter_rbsp;)f.shift();if(0===f.length)return this.resetStream_(),void this.trigger("done","VideoSegmentStream");b=this.groupNalsIntoFrames_(f),d=this.groupFramesIntoGops_(b),d[0][0].keyFrame||(c=this.getGopForFusion_(f[0],a),c?(d.unshift(c),d.byteLength+=c.byteLength,d.nalCount+=c.nalCount,d.pts=c.pts,d.dts=c.dts,d.duration+=c.duration):d=this.extendFirstKeyFrame_(d)),j(a,d),a.samples=this.generateSampleTable_(d),h=p.mdat(this.concatenateNalData_(d)),this.gopCache_.unshift({gop:d.pop(),pps:a.pps,sps:a.sps}),this.gopCache_.length=Math.min(6,this.gopCache_.length),f=[],l(a),this.trigger("timelineStartInfo",a.timelineStartInfo),g=p.moof(e,[a]),i=new Uint8Array(g.byteLength+h.byteLength),e++,i.set(g),i.set(h,g.byteLength),this.trigger("data",{track:a,boxes:i}),this.resetStream_(),this.trigger("done","VideoSegmentStream")},this.resetStream_=function(){k(a),b=void 0,c=void 0},this.getGopForFusion_=function(b){var c,d,e,f,g,h=1/0;for(g=0;g<this.gopCache_.length;g++)f=this.gopCache_[g],e=f.gop,a.pps&&m(a.pps[0],f.pps[0])&&a.sps&&m(a.sps[0],f.sps[0])&&(e.dts<a.timelineStartInfo.dts||(c=b.dts-e.dts-e.duration)>=-1e4&&c<=45e3&&(!d||h>c)&&(d=f,h=c));return d?d.gop:null},this.extendFirstKeyFrame_=function(a){var b;return!a[0][0].keyFrame&&a.length>1&&(b=a.shift(),a.byteLength-=b.byteLength,a.nalCount-=b.nalCount,a[0][0].dts=b.dts,a[0][0].pts=b.pts,a[0][0].duration+=b.duration),a},this.groupNalsIntoFrames_=function(a){var b,c,d=[],e=[];for(d.byteLength=0,b=0;b<a.length;b++)c=a[b],c.nalUnitType===s.h264.unitTypes.access_unit_delimiter_rbsp?(d.length&&(d.duration=c.dts-d.dts,e.push(d)),d=[c],d.byteLength=c.data.byteLength,d.pts=c.pts,d.dts=c.dts):(c.nalUnitType===s.h264.unitTypes.slice_layer_without_partitioning_rbsp_idr&&(d.keyFrame=!0),d.duration=c.dts-d.dts,d.byteLength+=c.data.byteLength,d.push(c));return e.length&&(!d.duration||d.duration<=0)&&(d.duration=e[e.length-1].duration),e.push(d),e},this.groupFramesIntoGops_=function(a){var b,c,d=[],e=[];for(d.byteLength=0,d.nalCount=0,d.duration=0,d.pts=a[0].pts,d.dts=a[0].dts,e.byteLength=0,e.nalCount=0,e.duration=0,e.pts=a[0].pts,e.dts=a[0].dts,b=0;b<a.length;b++)c=a[b],c.keyFrame?(d.length&&(e.push(d),e.byteLength+=d.byteLength,e.nalCount+=d.nalCount,e.duration+=d.duration),d=[c],d.nalCount=c.length,d.byteLength=c.byteLength,d.pts=c.pts,d.dts=c.dts,d.duration=c.duration):(d.duration+=c.duration,d.nalCount+=c.length,d.byteLength+=c.byteLength,d.push(c));return e.length&&d.duration<=0&&(d.duration=e[e.length-1].duration),e.byteLength+=d.byteLength,e.nalCount+=d.nalCount,e.duration+=d.duration,e.push(d),e},this.generateSampleTable_=function(a,b){var c,d,e,f,g,i=b||0,j=[];for(c=0;c<a.length;c++)for(f=a[c],d=0;d<f.length;d++)g=f[d],e=h(),e.dataOffset=i,e.compositionTimeOffset=g.pts-g.dts,e.duration=g.duration,e.size=4*g.length,e.size+=g.byteLength,g.keyFrame&&(e.flags.dependsOn=2),i+=e.size,j.push(e);return j},this.concatenateNalData_=function(a){var b,c,d,e,f,g,h=0,i=a.byteLength,j=a.nalCount,k=i+4*j,l=new Uint8Array(k),m=new DataView(l.buffer);for(b=0;b<a.length;b++)for(e=a[b],c=0;c<e.length;c++)for(f=e[c],d=0;d<f.length;d++)g=f[d],m.setUint32(h,g.data.byteLength),h+=4,l.set(g.data,h),h+=g.data.byteLength;return l}},d.prototype=new o,j=function(a,b){"number"==typeof b.pts&&(void 0===a.timelineStartInfo.pts&&(a.timelineStartInfo.pts=b.pts),void 0===a.minSegmentPts?a.minSegmentPts=b.pts:a.minSegmentPts=Math.min(a.minSegmentPts,b.pts),void 0===a.maxSegmentPts?a.maxSegmentPts=b.pts:a.maxSegmentPts=Math.max(a.maxSegmentPts,b.pts)),"number"==typeof b.dts&&(void 0===a.timelineStartInfo.dts&&(a.timelineStartInfo.dts=b.dts),void 0===a.minSegmentDts?a.minSegmentDts=b.dts:a.minSegmentDts=Math.min(a.minSegmentDts,b.dts),void 0===a.maxSegmentDts?a.maxSegmentDts=b.dts:a.maxSegmentDts=Math.max(a.maxSegmentDts,b.dts))},k=function(a){delete a.minSegmentDts,delete a.maxSegmentDts,delete a.minSegmentPts,delete a.maxSegmentPts},l=function(a){var b,c=a.minSegmentDts-a.timelineStartInfo.dts,d=a.minSegmentPts-a.minSegmentDts;return a.baseMediaDecodeTime=a.timelineStartInfo.baseMediaDecodeTime,a.baseMediaDecodeTime+=c,a.baseMediaDecodeTime-=d,a.baseMediaDecodeTime=Math.max(0,a.baseMediaDecodeTime),"audio"===a.type&&(b=a.samplerate/9e4,a.baseMediaDecodeTime*=b,a.baseMediaDecodeTime=Math.floor(a.baseMediaDecodeTime)),a.baseMediaDecodeTime},g=function(a,b){this.numberOfTracks=0,this.metadataStream=b,void 0!==a.remux?this.remuxTracks=!!a.remux:this.remuxTracks=!0,this.pendingTracks=[],this.videoTrack=null,this.pendingBoxes=[],this.pendingCaptions=[],
this.pendingMetadata=[],this.pendingBytes=0,this.emittedTracks=0,g.prototype.init.call(this),this.push=function(a){return a.text?this.pendingCaptions.push(a):a.frames?this.pendingMetadata.push(a):(this.pendingTracks.push(a.track),this.pendingBoxes.push(a.boxes),this.pendingBytes+=a.boxes.byteLength,"video"===a.track.type&&(this.videoTrack=a.track),void("audio"===a.track.type&&(this.audioTrack=a.track)))}},g.prototype=new o,g.prototype.flush=function(a){var b,c,d,e,f=0,g={captions:[],metadata:[],info:{}},h=0;if(this.pendingTracks.length<this.numberOfTracks){if("VideoSegmentStream"!==a&&"AudioSegmentStream"!==a)return;if(this.remuxTracks)return;if(0===this.pendingTracks.length)return void(++this.emittedTracks>=this.numberOfTracks&&(this.trigger("done"),this.emittedTracks=0))}for(this.videoTrack?(h=this.videoTrack.timelineStartInfo.pts,x.forEach(function(a){g.info[a]=this.videoTrack[a]},this)):this.audioTrack&&(h=this.audioTrack.timelineStartInfo.pts,w.forEach(function(a){g.info[a]=this.audioTrack[a]},this)),1===this.pendingTracks.length?g.type=this.pendingTracks[0].type:g.type="combined",this.emittedTracks+=this.pendingTracks.length,d=p.initSegment(this.pendingTracks,this.options),this.pendingBytes+=d.byteLength,this.pendingBoxes.unshift(d),g.data=new Uint8Array(this.pendingBytes),e=0;e<this.pendingBoxes.length;e++)g.data.set(this.pendingBoxes[e],f),f+=this.pendingBoxes[e].byteLength;for(e=0;e<this.pendingCaptions.length;e++)b=this.pendingCaptions[e],b.startTime=b.startPts-h,b.startTime/=9e4,b.endTime=b.endPts-h,b.endTime/=9e4,g.captions.push(b);for(e=0;e<this.pendingMetadata.length;e++)c=this.pendingMetadata[e],c.cueTime=c.pts-h,c.cueTime/=9e4,g.metadata.push(c);g.metadata.dispatchType=this.metadataStream.dispatchType,this.pendingTracks.length=0,this.videoTrack=null,this.pendingBoxes.length=0,this.pendingCaptions.length=0,this.pendingBytes=0,this.pendingMetadata.length=0,this.trigger("data",g),this.emittedTracks>=this.numberOfTracks&&(this.trigger("done"),this.emittedTracks=0)},f=function(a){var b,c,h=this,j=!0;f.prototype.init.call(this),a=a||{},a.input_type=a.input_type||"ts",void 0===a.break_on_count&&(a.break_on_count=!0),this.baseMediaDecodeTime=a.baseMediaDecodeTime||0,this.transmuxPipeline_={},this.setupAacPipeline=function(){var b={};this.transmuxPipeline_=b,b.type="aac",b.metadataStream=new r.MetadataStream,b.aacStream=new v,b.audioTimestampRolloverStream=new r.TimestampRolloverStream("audio"),b.timedMetadataTimestampRolloverStream=new r.TimestampRolloverStream("timed-metadata"),b.adtsStream=new t,b.coalesceStream=new g(a,b.metadataStream),b.headOfPipeline=b.aacStream,b.aacStream.pipe(b.audioTimestampRolloverStream).pipe(b.adtsStream),b.aacStream.pipe(b.timedMetadataTimestampRolloverStream).pipe(b.metadataStream).pipe(b.coalesceStream),b.metadataStream.on("timestamp",function(a){b.aacStream.setTimestamp(a.timeStamp)}),b.aacStream.on("data",function(a){"timed-metadata"!==a.type||b.audioSegmentStream||(c=c||{timelineStartInfo:{baseMediaDecodeTime:h.baseMediaDecodeTime},codec:"adts",type:"audio"},b.coalesceStream.numberOfTracks++,b.audioSegmentStream=new e(c),b.adtsStream.pipe(b.audioSegmentStream).pipe(b.coalesceStream))}),b.coalesceStream.on("data",this.trigger.bind(this,"data")),b.coalesceStream.on("done",this.trigger.bind(this,"done"))},this.setupTsPipeline=function(){var f={};this.transmuxPipeline_=f,f.type=a.input_type,"ts"==f.type?(a.metadataStream=f.metadataStream=new r.MetadataStream,f.packetStream=new r.TransportPacketStream,f.parseStream=new r.TransportParseStream,f.elementaryStream=new r.ElementaryStream,f.videoTimestampRolloverStream=new r.TimestampRolloverStream("video"),f.audioTimestampRolloverStream=new r.TimestampRolloverStream("audio"),f.timedMetadataTimestampRolloverStream=new r.TimestampRolloverStream("timed-metadata"),f.adtsStream=new t,f.h264Stream=new u,f.captionStream=new r.CaptionStream,f.coalesceStream=new g(a,f.metadataStream),f.headOfPipeline=f.packetStream,f.packetStream.pipe(f.parseStream).pipe(f.elementaryStream),f.elementaryStream.pipe(f.videoTimestampRolloverStream).pipe(f.h264Stream),f.elementaryStream.pipe(f.audioTimestampRolloverStream).pipe(f.adtsStream),f.elementaryStream.pipe(f.timedMetadataTimestampRolloverStream).pipe(f.metadataStream).pipe(f.coalesceStream),f.h264Stream.pipe(f.captionStream).pipe(f.coalesceStream)):(f.headOfPipeline=f.elementaryStream=new q.MP4ParserStream(a),f.mp4BuilderStream=new q.MP4BuilderStream(a),f.elementaryStream.pipe(f.mp4BuilderStream),this.seek=function(a,b){return f.elementaryStream.seek(a,b)},this.get_tl=function(a){return f.elementaryStream.get_tl(a)},this.conf_update=function(a){f.elementaryStream.trigger("confupdate",a),f.mp4BuilderStream.trigger("confupdate",a)}),f.elementaryStream.on("data",function(g){var i;if("metadata"===g.type){if("mp4"===a.input_type)return void h.trigger("metadata",g);for(i=g.tracks.length;i--;)b||"video"!==g.tracks[i].type?c||"audio"!==g.tracks[i].type||(c=g.tracks[i],c.timelineStartInfo.baseMediaDecodeTime=h.baseMediaDecodeTime):(b=g.tracks[i],b.timelineStartInfo.baseMediaDecodeTime=h.baseMediaDecodeTime);b&&!f.videoSegmentStream&&(f.coalesceStream.numberOfTracks++,f.videoSegmentStream=new d(b),f.videoSegmentStream.on("timelineStartInfo",function(a){c&&(c.timelineStartInfo=a,f.audioSegmentStream.setEarliestDts(a.dts))}),f.h264Stream.pipe(f.videoSegmentStream).pipe(f.coalesceStream)),c&&!f.audioSegmentStream&&(f.coalesceStream.numberOfTracks++,f.audioSegmentStream=new e(c),f.adtsStream.pipe(f.audioSegmentStream).pipe(f.coalesceStream))}}),"mp4"===a.input_type?(f.mp4BuilderStream.on("data",this.trigger.bind(this,"data")),f.mp4BuilderStream.on("done",this.trigger.bind(this,"done"))):(f.coalesceStream.on("data",this.trigger.bind(this,"data")),f.coalesceStream.on("done",this.trigger.bind(this,"done")))},this.setBaseMediaDecodeTime=function(a){var d=this.transmuxPipeline_;this.baseMediaDecodeTime=a,c&&(c.timelineStartInfo.dts=void 0,c.timelineStartInfo.pts=void 0,k(c),c.timelineStartInfo.baseMediaDecodeTime=a),b&&(d.videoSegmentStream&&(d.videoSegmentStream.gopCache_=[]),b.timelineStartInfo.dts=void 0,b.timelineStartInfo.pts=void 0,k(b),b.timelineStartInfo.baseMediaDecodeTime=a)},this.push=function(b){if(j){var c=i(b)&&"mp4"!=a.input_type;c&&"aac"!==this.transmuxPipeline_.type?this.setupAacPipeline():c||this.transmuxPipeline_.type===a.input_type||this.setupTsPipeline(),j=!1}return this.transmuxPipeline_.headOfPipeline.push(b)},this.appendBuffer=function(a){return this.push(new Uint8Array(a))},this.flush=function(){j=!0,this.transmuxPipeline_.headOfPipeline.flush()}},f.prototype=new o,b.exports={Transmuxer:f,VideoSegmentStream:d,AudioSegmentStream:e,AUDIO_PROPERTIES:w,VIDEO_PROPERTIES:x}},{"../aac":1,"../codecs":4,"../m2ts/m2ts.js":11,"../utils/stream.js":22,"./mp4-generator.js":16,"./mp4-parser.js":17}],19:[function(a,b,c){"use strict";var d={8:"audio",9:"video",18:"metadata"},e=function(a){return"0x"+("00"+a.toString(16)).slice(-2).toUpperCase()},f=function(a){for(var b,c=[];a.byteLength>0;){switch(b=0,a.byteLength){default:c.push(e(a[b++]));case 7:c.push(e(a[b++]));case 6:c.push(e(a[b++]));case 5:c.push(e(a[b++]));case 4:c.push(e(a[b++]));case 3:c.push(e(a[b++]));case 2:c.push(e(a[b++]));case 1:c.push(e(a[b++]))}a=a.subarray(b)}return c.join(" ")},g=function(a,b){var c=["AVC Sequence Header","AVC NALU","AVC End-of-Sequence"],d=a[1]&parseInt("01111111",2)<<16|a[2]<<8|a[3];return b=b||{},b.avcPacketType=c[a[0]],b.CompositionTime=a[1]&parseInt("10000000",2)?-d:d,1===a[0]?b.nalUnitTypeRaw=f(a.subarray(4,100)):b.data=f(a.subarray(4)),b},h=function(a,b){var c=["Unknown","Keyframe (for AVC, a seekable frame)","Inter frame (for AVC, a nonseekable frame)","Disposable inter frame (H.263 only)","Generated keyframe (reserved for server use only)","Video info/command frame"],d=a[0]&parseInt("00001111",2);return b=b||{},b.frameType=c[(a[0]&parseInt("11110000",2))>>>4],b.codecID=d,7===d?g(a.subarray(1),b):b},i=function(a,b){var c=["AAC Sequence Header","AAC Raw"];return b=b||{},b.aacPacketType=c[a[0]],b.data=f(a.subarray(1)),b},j=function(a,b){var c=["Linear PCM, platform endian","ADPCM","MP3","Linear PCM, little endian","Nellymoser 16-kHz mono","Nellymoser 8-kHz mono","Nellymoser","G.711 A-law logarithmic PCM","G.711 mu-law logarithmic PCM","reserved","AAC","Speex","MP3 8-Khz","Device-specific sound"],d=["5.5-kHz","11-kHz","22-kHz","44-kHz"],e=(a[0]&parseInt("11110000",2))>>>4;return b=b||{},b.soundFormat=c[e],b.soundRate=d[(a[0]&parseInt("00001100",2))>>>2],b.soundSize=(a[0]&parseInt("00000010",2))>>>1?"16-bit":"8-bit",b.soundType=a[0]&parseInt("00000001",2)?"Stereo":"Mono",10===e?i(a.subarray(1),b):b},k=function(a){return{tagType:d[a[0]],dataSize:a[1]<<16|a[2]<<8|a[3],timestamp:a[7]<<24|a[4]<<16|a[5]<<8|a[6],streamID:a[8]<<16|a[9]<<8|a[10]}},l=function(a){var b=k(a);switch(a[0]){case 8:j(a.subarray(11),b);break;case 9:h(a.subarray(11),b)}return b},m=function(a){var b,c,d=9,e=[];for(d+=4;d<a.byteLength;)b=a[d+1]<<16,b|=a[d+2]<<8,b|=a[d+3],b+=11,c=a.subarray(d,d+b),e.push(l(c)),d+=b+4;return e},n=function(a){return JSON.stringify(a,null,2)};b.exports={inspectTag:l,inspect:m,textify:n}},{}],20:[function(a,b,c){(function(a){"use strict";var c,d,e=function(a){var b="";return b+=String.fromCharCode(a[0]),b+=String.fromCharCode(a[1]),b+=String.fromCharCode(a[2]),b+=String.fromCharCode(a[3])},f=function(a){return new Date(1e3*a-20828448e5)},g=function(a){return{isLeading:(12&a[0])>>>2,dependsOn:3&a[0],isDependedOn:(192&a[1])>>>6,hasRedundancy:(48&a[1])>>>4,paddingValue:(14&a[1])>>>1,isNonSyncSample:1&a[1],degradationPriority:a[2]<<8|a[3]}},h=function(a){var b,c,d=new DataView(a.buffer,a.byteOffset,a.byteLength),e=[];for(b=0;b+4<a.length;b+=c)if(c=d.getUint32(b),b+=4,c<=0)e.push("<span style='color:red;'>MALFORMED DATA</span>");else switch(31&a[b]){case 1:e.push("slice_layer_without_partitioning_rbsp");break;case 5:e.push("slice_layer_without_partitioning_rbsp_idr");break;case 6:e.push("sei_rbsp");break;case 7:e.push("seq_parameter_set_rbsp");break;case 8:e.push("pic_parameter_set_rbsp");break;case 9:e.push("access_unit_delimiter_rbsp");break;default:e.push("UNKNOWN NAL - "+a[b]&31)}return e},i={avc1:function(a){var b=new DataView(a.buffer,a.byteOffset,a.byteLength);return{dataReferenceIndex:b.getUint16(6),width:b.getUint16(24),height:b.getUint16(26),horizresolution:b.getUint16(28)+b.getUint16(30)/16,vertresolution:b.getUint16(32)+b.getUint16(34)/16,frameCount:b.getUint16(40),depth:b.getUint16(74),config:c(a.subarray(78,a.byteLength))}},avcC:function(a){var b,c,d,e,f=new DataView(a.buffer,a.byteOffset,a.byteLength),g={configurationVersion:a[0],avcProfileIndication:a[1],profileCompatibility:a[2],avcLevelIndication:a[3],lengthSizeMinusOne:3&a[4],sps:[],pps:[]},h=31&a[5];for(d=6,e=0;e<h;e++)c=f.getUint16(d),d+=2,g.sps.push(new Uint8Array(a.subarray(d,d+c))),d+=c;for(b=a[d],d++,e=0;e<b;e++)c=f.getUint16(d),d+=2,g.pps.push(new Uint8Array(a.subarray(d,d+c))),d+=c;return g},btrt:function(a){var b=new DataView(a.buffer,a.byteOffset,a.byteLength);return{bufferSizeDB:b.getUint32(0),maxBitrate:b.getUint32(4),avgBitrate:b.getUint32(8)}},esds:function(a){return{version:a[0],flags:new Uint8Array(a.subarray(1,4)),esId:a[6]<<8|a[7],streamPriority:31&a[8],decoderConfig:{objectProfileIndication:a[11],streamType:a[12]>>>2&63,bufferSize:a[13]<<16|a[14]<<8|a[15],maxBitrate:a[16]<<24|a[17]<<16|a[18]<<8|a[19],avgBitrate:a[20]<<24|a[21]<<16|a[22]<<8|a[23],decoderConfigDescriptor:{tag:a[24],length:a[25],audioObjectType:a[26]>>>3&31,samplingFrequencyIndex:(7&a[26])<<1|a[27]>>>7&1,channelConfiguration:a[27]>>>3&15}}}},ftyp:function(a){for(var b=new DataView(a.buffer,a.byteOffset,a.byteLength),c={majorBrand:e(a.subarray(0,4)),minorVersion:b.getUint32(4),compatibleBrands:[]},d=8;d<a.byteLength;)c.compatibleBrands.push(e(a.subarray(d,d+4))),d+=4;return c},dinf:function(a){return{boxes:c(a)}},dref:function(a){return{version:a[0],flags:new Uint8Array(a.subarray(1,4)),dataReferences:c(a.subarray(8))}},hdlr:function(b){var c=new DataView(b.buffer,b.byteOffset,b.byteLength),d={version:c.getUint8(0),flags:new Uint8Array(b.subarray(1,4)),handlerType:e(b.subarray(8,12)),name:""},f=8;for(f=24;f<b.byteLength;f++){if(0===b[f]){f++;break}d.name+=String.fromCharCode(b[f])}return d.name=decodeURIComponent(a.escape(d.name)),d},mdat:function(a){return{byteLength:a.byteLength,nals:h(a)}},mdhd:function(a){var b,c=new DataView(a.buffer,a.byteOffset,a.byteLength),d=4,e={version:c.getUint8(0),flags:new Uint8Array(a.subarray(1,4)),language:""};return 1===e.version?(d+=4,e.creationTime=f(c.getUint32(d)),d+=8,e.modificationTime=f(c.getUint32(d)),d+=4,e.timescale=c.getUint32(d),d+=8,e.duration=c.getUint32(d)):(e.creationTime=f(c.getUint32(d)),d+=4,e.modificationTime=f(c.getUint32(d)),d+=4,e.timescale=c.getUint32(d),d+=4,e.duration=c.getUint32(d)),d+=4,b=c.getUint16(d),e.language+=String.fromCharCode(96+(b>>10)),e.language+=String.fromCharCode(96+((960&b)>>5)),e.language+=String.fromCharCode(96+(31&b)),e},mdia:function(a){return{boxes:c(a)}},mfhd:function(a){return{version:a[0],flags:new Uint8Array(a.subarray(1,4)),sequenceNumber:a[4]<<24|a[5]<<16|a[6]<<8|a[7]}},minf:function(a){return{boxes:c(a)}},mp4a:function(a){var b=new DataView(a.buffer,a.byteOffset,a.byteLength),d={dataReferenceIndex:b.getUint16(6),channelcount:b.getUint16(16),samplesize:b.getUint16(18),samplerate:b.getUint16(24)+b.getUint16(26)/65536};return a.byteLength>28&&(d.streamDescriptor=c(a.subarray(28))[0]),d},moof:function(a){return{boxes:c(a)}},moov:function(a){return{boxes:c(a)}},mvex:function(a){return{boxes:c(a)}},mvhd:function(a){var b=new DataView(a.buffer,a.byteOffset,a.byteLength),c=4,d={version:b.getUint8(0),flags:new Uint8Array(a.subarray(1,4))};return 1===d.version?(c+=4,d.creationTime=f(b.getUint32(c)),c+=8,d.modificationTime=f(b.getUint32(c)),c+=4,d.timescale=b.getUint32(c),c+=8,d.duration=b.getUint32(c)):(d.creationTime=f(b.getUint32(c)),c+=4,d.modificationTime=f(b.getUint32(c)),c+=4,d.timescale=b.getUint32(c),c+=4,d.duration=b.getUint32(c)),c+=4,d.rate=b.getUint16(c)+b.getUint16(c+2)/16,c+=4,d.volume=b.getUint8(c)+b.getUint8(c+1)/8,c+=2,c+=2,c+=8,d.matrix=new Uint32Array(a.subarray(c,c+36)),c+=36,c+=24,d.nextTrackId=b.getUint32(c),d},pdin:function(a){var b=new DataView(a.buffer,a.byteOffset,a.byteLength);return{version:b.getUint8(0),flags:new Uint8Array(a.subarray(1,4)),rate:b.getUint32(4),initialDelay:b.getUint32(8)}},sdtp:function(a){var b,c={version:a[0],flags:new Uint8Array(a.subarray(1,4)),samples:[]};for(b=4;b<a.byteLength;b++)c.samples.push({dependsOn:(48&a[b])>>4,isDependedOn:(12&a[b])>>2,hasRedundancy:3&a[b]});return c},sidx:function(a){var b,c=new DataView(a.buffer,a.byteOffset,a.byteLength),d={version:a[0],flags:new Uint8Array(a.subarray(1,4)),references:[],referenceId:c.getUint32(4),timescale:c.getUint32(8),earliestPresentationTime:c.getUint32(12),firstOffset:c.getUint32(16)},e=c.getUint16(22);for(b=24;e;b+=12,e--)d.references.push({referenceType:(128&a[b])>>>7,referencedSize:2147483647&c.getUint32(b),subsegmentDuration:c.getUint32(b+4),startsWithSap:!!(128&a[b+8]),sapType:(112&a[b+8])>>>4,sapDeltaTime:268435455&c.getUint32(b+8)});return d},smhd:function(a){return{version:a[0],flags:new Uint8Array(a.subarray(1,4)),balance:a[4]+a[5]/256}},stbl:function(a){return{boxes:c(a)}},stco:function(a){var b,c=new DataView(a.buffer,a.byteOffset,a.byteLength),d={version:a[0],flags:new Uint8Array(a.subarray(1,4)),chunkOffsets:[]},e=c.getUint32(4);for(b=8;e;b+=4,e--)d.chunkOffsets.push(c.getUint32(b));return d},stsc:function(a){var b,c=new DataView(a.buffer,a.byteOffset,a.byteLength),d=c.getUint32(4),e={version:a[0],flags:new Uint8Array(a.subarray(1,4)),sampleToChunks:[]};for(b=8;d;b+=12,d--)e.sampleToChunks.push({firstChunk:c.getUint32(b),samplesPerChunk:c.getUint32(b+4),sampleDescriptionIndex:c.getUint32(b+8)});return e},stsd:function(a){return{version:a[0],flags:new Uint8Array(a.subarray(1,4)),sampleDescriptions:c(a.subarray(8))}},stsz:function(a){var b,c=new DataView(a.buffer,a.byteOffset,a.byteLength),d={version:a[0],flags:new Uint8Array(a.subarray(1,4)),sampleSize:c.getUint32(4),entries:[]};for(b=12;b<a.byteLength;b+=4)d.entries.push(c.getUint32(b));return d},stts:function(a){var b,c=new DataView(a.buffer,a.byteOffset,a.byteLength),d={version:a[0],flags:new Uint8Array(a.subarray(1,4)),timeToSamples:[]},e=c.getUint32(4);for(b=8;e;b+=8,e--)d.timeToSamples.push({sampleCount:c.getUint32(b),sampleDelta:c.getUint32(b+4)});return d},styp:function(a){return i.ftyp(a)},tfdt:function(a){return{version:a[0],flags:new Uint8Array(a.subarray(1,4)),baseMediaDecodeTime:a[4]<<24|a[5]<<16|a[6]<<8|a[7]}},tfhd:function(a){var b,c=new DataView(a.buffer,a.byteOffset,a.byteLength),d={version:a[0],flags:new Uint8Array(a.subarray(1,4)),trackId:c.getUint32(4)},e=1&d.flags[2],f=2&d.flags[2],g=8&d.flags[2],h=16&d.flags[2],i=32&d.flags[2];return b=8,e&&(b+=4,d.baseDataOffset=c.getUint32(12),b+=4),f&&(d.sampleDescriptionIndex=c.getUint32(b),b+=4),g&&(d.defaultSampleDuration=c.getUint32(b),b+=4),h&&(d.defaultSampleSize=c.getUint32(b),b+=4),i&&(d.defaultSampleFlags=c.getUint32(b)),d},tkhd:function(a){var b=new DataView(a.buffer,a.byteOffset,a.byteLength),c=4,d={version:b.getUint8(0),flags:new Uint8Array(a.subarray(1,4))};return 1===d.version?(c+=4,d.creationTime=f(b.getUint32(c)),c+=8,d.modificationTime=f(b.getUint32(c)),c+=4,d.trackId=b.getUint32(c),c+=4,c+=8,d.duration=b.getUint32(c)):(d.creationTime=f(b.getUint32(c)),c+=4,d.modificationTime=f(b.getUint32(c)),c+=4,d.trackId=b.getUint32(c),c+=4,c+=4,d.duration=b.getUint32(c)),c+=4,c+=8,d.layer=b.getUint16(c),c+=2,d.alternateGroup=b.getUint16(c),c+=2,d.volume=b.getUint8(c)+b.getUint8(c+1)/8,c+=2,c+=2,d.matrix=new Uint32Array(a.subarray(c,c+36)),c+=36,d.width=b.getUint16(c)+b.getUint16(c+2)/16,c+=4,d.height=b.getUint16(c)+b.getUint16(c+2)/16,d},traf:function(a){return{boxes:c(a)}},trak:function(a){return{boxes:c(a)}},trex:function(a){var b=new DataView(a.buffer,a.byteOffset,a.byteLength);return{version:a[0],flags:new Uint8Array(a.subarray(1,4)),trackId:b.getUint32(4),defaultSampleDescriptionIndex:b.getUint32(8),defaultSampleDuration:b.getUint32(12),defaultSampleSize:b.getUint32(16),sampleDependsOn:3&a[20],sampleIsDependedOn:(192&a[21])>>6,sampleHasRedundancy:(48&a[21])>>4,samplePaddingValue:(14&a[21])>>1,sampleIsDifferenceSample:!!(1&a[21]),sampleDegradationPriority:b.getUint16(22)}},trun:function(a){var b,c={version:a[0],flags:new Uint8Array(a.subarray(1,4)),samples:[]},d=new DataView(a.buffer,a.byteOffset,a.byteLength),e=1&c.flags[2],f=4&c.flags[2],h=1&c.flags[1],i=2&c.flags[1],j=4&c.flags[1],k=8&c.flags[1],l=d.getUint32(4),m=8;for(e&&(c.dataOffset=d.getUint32(m),m+=4),f&&l&&(b={flags:g(a.subarray(m,m+4))},m+=4,h&&(b.duration=d.getUint32(m),m+=4),i&&(b.size=d.getUint32(m),m+=4),k&&(b.compositionTimeOffset=d.getUint32(m),m+=4),c.samples.push(b),l--);l--;)b={},h&&(b.duration=d.getUint32(m),m+=4),i&&(b.size=d.getUint32(m),m+=4),j&&(b.flags=g(a.subarray(m,m+4)),m+=4),k&&(b.compositionTimeOffset=d.getUint32(m),m+=4),c.samples.push(b);return c},"url ":function(a){return{version:a[0],flags:new Uint8Array(a.subarray(1,4))}},vmhd:function(a){var b=new DataView(a.buffer,a.byteOffset,a.byteLength);return{version:a[0],flags:new Uint8Array(a.subarray(1,4)),graphicsmode:b.getUint16(4),opcolor:new Uint16Array([b.getUint16(6),b.getUint16(8),b.getUint16(10)])}}};c=function(a){for(var b,c,d,f,g,h=0,j=[],k=new ArrayBuffer(a.length),l=new Uint8Array(k),m=0;m<a.length;++m)l[m]=a[m];for(b=new DataView(k);h<a.byteLength;)c=b.getUint32(h),d=e(a.subarray(h+4,h+8)),f=c>1?h+c:a.byteLength,g=(i[d]||function(a){return{data:a}})(a.subarray(h+8,f)),g.size=c,g.type=d,j.push(g),h=f;return j},d=function(a,b){var c;return b=b||0,c=new Array(2*b+1).join(" "),a.map(function(a,e){return c+a.type+"\n"+Object.keys(a).filter(function(a){return"type"!==a&&"boxes"!==a}).map(function(b){var d=c+"  "+b+": ",e=a[b];if(e instanceof Uint8Array||e instanceof Uint32Array){var f=Array.prototype.slice.call(new Uint8Array(e.buffer,e.byteOffset,e.byteLength)).map(function(a){return" "+("00"+a.toString(16)).slice(-2)}).join("").match(/.{1,24}/g);return f?1===f.length?d+"<"+f.join("").slice(1)+">":d+"<\n"+f.map(function(a){return c+"  "+a}).join("\n")+"\n"+c+"  >":d+"<>"}return d+JSON.stringify(e,null,2).split("\n").map(function(a,b){return 0===b?a:c+"  "+a}).join("\n")}).join("\n")+(a.boxes?"\n"+d(a.boxes,b+1):"")}).join("\n")},b.exports={inspect:c,textify:d}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],21:[function(a,b,c){"use strict";var d;d=function(a){var b=a.byteLength,c=0,d=0;this.length=function(){return 8*b},this.bitsAvailable=function(){return 8*b+d},this.loadWord=function(){var e=a.byteLength-b,f=new Uint8Array(4),g=Math.min(4,b);if(0===g)throw new Error("no bytes available");f.set(a.subarray(e,e+g)),c=new DataView(f.buffer).getUint32(0),d=8*g,b-=g},this.skipBits=function(a){var e;d>a?(c<<=a,d-=a):(a-=d,e=Math.floor(a/8),a-=8*e,b-=e,this.loadWord(),c<<=a,d-=a)},this.readBits=function(a){var e=Math.min(d,a),f=c>>>32-e;return d-=e,d>0?c<<=e:b>0&&this.loadWord(),e=a-e,e>0&&d?f<<e|this.readBits(e):f},this.skipLeadingZeros=function(){var a;for(a=0;a<d;++a)if(0!=(c&2147483648>>>a))return c<<=a,d-=a,a;return this.loadWord(),a+this.skipLeadingZeros()},this.skipUnsignedExpGolomb=function(){this.skipBits(1+this.skipLeadingZeros())},this.skipExpGolomb=function(){this.skipBits(1+this.skipLeadingZeros())},this.readUnsignedExpGolomb=function(){var a=this.skipLeadingZeros();return this.readBits(a+1)-1},this.readExpGolomb=function(){var a=this.readUnsignedExpGolomb();return 1&a?1+a>>>1:-(a>>>1)},this.readBoolean=function(){return 1===this.readBits(1)},this.readUnsignedByte=function(){return this.readBits(8)},this.loadWord()},b.exports=d},{}],22:[function(a,b,c){"use strict";var d=function(){this.init=function(){var a={};this.on=function(b,c){a[b]||(a[b]=[]),a[b].push(c)},this.off=function(b,c){var d;return!!a[b]&&(d=a[b].indexOf(c),a[b].splice(d,1),d>-1)},this.trigger=function(b){var c,d,e,f;if(c=a[b])if(c=c.slice(0),2===arguments.length)for(e=c.length,d=0;d<e;++d)c[d].call(this,arguments[1]);else{for(f=[],d=arguments.length,d=1;d<arguments.length;++d)f.push(arguments[d]);for(e=c.length,d=0;d<e;++d)c[d].apply(this,f)}},this.dispose=function(){a={}}}};d.prototype.pipe=function(a){return this.on("data",function(b){a.push(b)}),this.on("done",function(b){a.flush(b)}),a},d.prototype.push=function(a){this.trigger("data",a)},d.prototype.flush=function(a){this.trigger("done",a)},b.exports=d},{}],23:[function(a,b,c){b.exports=a("@hola.org/mux.js")},{"@hola.org/mux.js":8}]},{},[23])(23)});
//# sourceMappingURL=hola_mux.min.js.map